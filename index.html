<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <!-- CRITICAL: Ensures proper scaling on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>صفحه کاربري دانشجويي</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vazirmatn Font -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4f46e5;
      --secondary-color: #10b981;
      --text-color: #1f2937;
    }
    body {
      font-family: "Vazirmatn", sans-serif;
      color: var(--text-color);
      background-color: #f3f4f6;
    }
    .btn-primary {
      background-color: var(--primary-color);
      transition: background-color 0.2s;
    }
    .btn-primary:hover {
      background-color: #4338ca;
    }
    .btn-secondary {
      background-color: var(--secondary-color);
      transition: background-color 0.2s;
    }
    .btn-secondary:hover {
      background-color: #059669;
    }
    .tab-active {
      border-color: var(--primary-color);
      color: var(--primary-color);
      font-weight: 700;
    }
    .card {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }
    .hidden { display: none !important; }

    /* Custom Scrollbar for better UX */
    .custom-scroll::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
        background-color: #9ca3af;
        border-radius: 10px;
    }
    .custom-scroll::-webkit-scrollbar-track {
        background: #e5e7eb;
    }

    /* Auth View specific styling for centering */
    .auth-container {
        max-width: 450px;
        margin: 4rem auto;
        padding: 0 1rem; /* Added padding for small screens */
    }

    /* Mobile optimization for tabs */
    .nav-tabs {
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
        border-bottom: 2px solid #e5e7eb;
        /* Hides scrollbar on some browsers */
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    .nav-tabs::-webkit-scrollbar {
        display: none; /* Chrome, Safari and Opera */
    }
    .tab-button {
        flex-shrink: 0; /* Prevents buttons from shrinking on mobile */
    }
    
    /* Responsive Grade Progress bar */
    .progress-bar {
        height: 8px;
        border-radius: 4px;
        background-color: #e5e7eb;
    }
    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease-in-out;
    }

  </style>
</head>
<body class="p-4 md:p-8">

  <!-- Message Box (Used for all notifications) -->
  <div id="message-box" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 p-4 rounded-lg shadow-xl text-white font-medium hidden"></div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-2xl flex items-center space-x-3 space-x-reverse">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
      <p class="text-indigo-700 text-lg font-medium" id="loading-text">در حال راه‌اندازی...</p>
    </div>
  </div>


  <!-- Authentication View (Login, Register, Forgot Password) -->
  <div id="auth-view" class="auth-container">
    
    <div id="login-form-container" class="bg-white p-6 md:p-8 card rounded-xl transition duration-300">
        <h2 class="text-2xl md:text-3xl font-bold text-indigo-700 mb-6 text-center">ورود به داشبورد</h2>
        <form id="login-form" class="space-y-4">
            <div>
                <label for="login-email" class="block text-sm font-medium text-gray-700">ایمیل</label>
                <input type="email" id="login-email" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
            </div>
            <div class="relative">
                <label for="login-password" class="block text-sm font-medium text-gray-700">رمز عبور</label>
                <input type="password" id="login-password" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                <span onclick="togglePasswordVisibility('login-password')" class="absolute inset-y-0 left-0 flex items-center pl-3 cursor-pointer mt-6">
                    <i id="login-password-toggle" class="fas fa-eye text-gray-500 hover:text-indigo-600"></i>
                </span>
            </div>
            <button type="submit" class="btn-primary text-white py-3 px-4 rounded-lg w-full text-lg font-semibold">
                <i class="fas fa-sign-in-alt ml-2"></i>ورود
            </button>
        </form>
        <p class="mt-6 text-center text-sm">
            <button onclick="showAuthForm('register')" class="text-indigo-600 hover:text-indigo-800 font-medium">حساب کاربری ندارید؟ ثبت نام کنید</button>
        </p>
        <p class="mt-2 text-center text-sm">
            <button onclick="showAuthForm('forgot-password')" class="text-red-500 hover:text-red-700 font-medium">فراموشی رمز عبور</button>
        </p>
    </div>

    <!-- Registration Form -->
    <div id="register-form-container" class="bg-white p-6 md:p-8 card rounded-xl hidden transition duration-300">
        <h2 class="text-2xl md:text-3xl font-bold text-indigo-700 mb-6 text-center">ثبت نام کاربر جدید</h2>
        <form id="register-form" class="space-y-4">
            <div>
                <label for="register-email" class="block text-sm font-medium text-gray-700">ایمیل</label>
                <input type="email" id="register-email" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
            </div>
            <div class="relative">
                <label for="register-password" class="block text-sm font-medium text-gray-700">رمز عبور (حداقل ۶ کاراکتر)</label>
                <input type="password" id="register-password" required minlength="6" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                <span onclick="togglePasswordVisibility('register-password')" class="absolute inset-y-0 left-0 flex items-center pl-3 cursor-pointer mt-6">
                    <i id="register-password-toggle" class="fas fa-eye text-gray-500 hover:text-indigo-600"></i>
                </span>
            </div>
            <button type="submit" class="btn-primary text-white py-3 px-4 rounded-lg w-full text-lg font-semibold">
                <i class="fas fa-user-plus ml-2"></i>ثبت نام
            </button>
        </form>
        <p class="mt-6 text-center text-sm">
            <button onclick="showAuthForm('login')" class="text-indigo-600 hover:text-indigo-800 font-medium">قبلاً ثبت نام کرده‌اید؟ ورود</button>
        </p>
    </div>

    <!-- Forgot Password Form -->
    <div id="forgot-password-container" class="bg-white p-6 md:p-8 card rounded-xl hidden transition duration-300">
        <h2 class="text-2xl md:text-3xl font-bold text-indigo-700 mb-6 text-center">بازیابی رمز عبور</h2>
        <p class="text-center text-gray-600 mb-6">ایمیل خود را وارد کنید تا لینک بازیابی برایتان ارسال شود.</p>
        <form id="forgot-password-form" class="space-y-4">
            <div>
                <label for="forgot-email" class="block text-sm font-medium text-gray-700">ایمیل</label>
                <input type="email" id="forgot-email" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
            </div>
            <button type="submit" class="btn-primary text-white py-3 px-4 rounded-lg w-full text-lg font-semibold">
                <i class="fas fa-envelope ml-2"></i>ارسال لینک بازیابی
            </button>
        </form>
        <p class="mt-6 text-center text-sm">
            <button onclick="showAuthForm('login')" class="text-indigo-600 hover:text-indigo-800 font-medium">بازگشت به صفحه ورود</button>
        </p>
    </div>

  </div> <!-- End of Auth View -->


  <!-- Dashboard View (Hidden until authenticated) -->
  <div id="dashboard-view" class="hidden">
    <!-- Header -->
    <header class="mb-6 p-4 bg-white card rounded-xl flex justify-between items-center flex-wrap gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold text-indigo-700 mb-1">داشبورد دانشجویی من</h1>
        <p class="text-gray-500 text-sm md:text-base mb-3">مدیریت دروس، نمرات، برنامه‌ریزی هفتگی، امتحانات و محاسبه معدل.</p>
        <!-- User Info is responsive, using text-xs on small screens -->
        <div id="user-info-display" class="text-xs text-gray-400 font-mono overflow-x-auto whitespace-nowrap">در حال بارگذاری اطلاعات کاربر...</div>
      </div>
      <button onclick="signOutUser()" class="bg-red-500 hover:bg-red-700 text-white py-2 px-3 rounded-lg font-medium flex items-center text-sm md:text-base">
        <i class="fas fa-sign-out-alt ml-2"></i>خروج
      </button>
    </header>

    <!-- Tabs (Optimized for Mobile Horizontal Scroll) -->
    <nav class="mb-6">
      <ul class="flex nav-tabs">
        <li class="mr-1">
          <button onclick="changeTab('overview')" class="tab-button inline-block py-2 px-4 text-gray-500 hover:text-indigo-600 hover:border-indigo-600 border-b-2 border-transparent transition duration-150 tab-active text-sm md:text-base" data-tab="overview">
            <i class="fas fa-chart-line ml-2"></i>خلاصه و معدل
          </button>
        </li>
        <li class="mr-1">
          <button onclick="changeTab('courses')" class="tab-button inline-block py-2 px-4 text-gray-500 hover:text-indigo-600 hover:border-indigo-600 border-b-2 border-transparent transition duration-150 text-sm md:text-base" data-tab="courses">
            <i class="fas fa-book-open ml-2"></i>مدیریت دروس و نمرات
          </button>
        </li>
        <li class="mr-1">
          <button onclick="changeTab('weekly')" class="tab-button inline-block py-2 px-4 text-gray-500 hover:text-indigo-600 hover:border-indigo-600 border-b-2 border-transparent transition duration-150 text-sm md:text-base" data-tab="weekly">
            <i class="fas fa-calendar-alt ml-2"></i>برنامه‌ریزی هفتگی
          </button>
        </li>
        <li class="mr-1">
          <button onclick="changeTab('exams')" class="tab-button inline-block py-2 px-4 text-gray-500 hover:text-indigo-600 hover:border-indigo-600 border-b-2 border-transparent transition duration-150 text-sm md:text-base" data-tab="exams">
            <i class="fas fa-calendar-check ml-2"></i>امتحانات و رویدادها
          </button>
        </li>
      </ul>
    </nav>

    <!-- Content Sections (Tabs) -->

    <!-- 1. Overview Tab -->
    <section id="overview" class="tab-content">
      <!-- Grid adjusts from 1 column (mobile) to 2/3 columns (desktop) -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- GPA and Term Summary Card -->
        <div class="lg:col-span-2 bg-white p-6 card rounded-xl">
          <h2 class="text-xl md:text-2xl font-bold text-gray-700 mb-4 border-b pb-2">خلاصه معدل</h2>
          <!-- Flex layout adjusts items for small screens -->
          <div class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4">
            <div class="text-center p-4 bg-indigo-50 rounded-lg w-full sm:w-auto">
              <p class="text-4xl md:text-5xl font-extrabold text-indigo-600" id="total-gpa">--</p>
              <p class="text-gray-500 text-sm">معدل کل</p>
            </div>
            <!-- Smaller stats use wrap and justify-around for small screens -->
            <div class="flex flex-wrap gap-4 w-full sm:w-auto justify-around sm:justify-start">
              <div class="text-center p-3 bg-green-50 rounded-lg flex-1 min-w-[40%]">
                <p class="text-xl md:text-2xl font-bold text-green-600" id="total-units">--</p>
                <p class="text-xs text-gray-500">کل واحدها</p>
              </div>
              <div class="text-center p-3 bg-red-50 rounded-lg flex-1 min-w-[40%]">
                <p class="text-xl md:text-2xl font-bold text-red-600" id="passed-units">--</p>
                <p class="text-xs text-gray-500">واحدهای گذرانده</p>
              </div>
            </div>
          </div>

          <h3 class="text-lg md:text-xl font-semibold text-gray-700 mt-6 mb-3">تاریخچه ترم‌ها</h3>
          <!-- Table wrapped for mobile horizontal scroll -->
          <div class="overflow-x-auto custom-scroll">
            <table class="min-w-full bg-white rounded-lg border border-gray-200">
              <thead>
                <tr class="bg-gray-100 text-right text-gray-600 text-sm leading-normal">
                  <th class="py-3 px-4 md:px-6">ترم</th>
                  <th class="py-3 px-4 md:px-6">تعداد واحد</th>
                  <th class="py-3 px-4 md:px-6">معدل ترم</th>
                </tr>
              </thead>
              <tbody class="text-gray-600 text-sm font-light" id="terms-gpa-list">
                <!-- Term GPA data will be rendered here -->
                <tr><td colspan="3" class="text-center py-4">داده‌ای یافت نشد.</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Term Management Card -->
        <div class="bg-white p-6 card rounded-xl">
          <h2 class="text-xl md:text-2xl font-bold text-gray-700 mb-4 border-b pb-2">مدیریت ترم‌ها</h2>
          <form id="term-form" class="space-y-4">
            <div>
              <label for="new-term-name" class="block text-sm font-medium text-gray-700">نام ترم (مثال: نیمسال اول ۱۴۰۲)</label>
              <input type="text" id="new-term-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
            </div>
            <button type="submit" class="btn-primary text-white py-3 px-4 rounded-lg w-full text-sm md:text-base">
              <i class="fas fa-calendar-plus ml-2"></i>اضافه کردن ترم
            </button>
          </form>

          <h3 class="text-lg md:text-xl font-semibold text-gray-700 mt-6 mb-3 border-t pt-4">لیست ترم‌ها</h3>
          <ul id="term-list" class="space-y-2 max-h-60 overflow-y-auto custom-scroll">
            <!-- Term list items will be rendered here -->
            <li class="text-gray-500 text-sm">ترم فعالی تعریف نشده است.</li>
          </ul>
        </div>

      </div>
    </section>

    <!-- 2. Courses and Grades Tab -->
    <section id="courses" class="tab-content hidden">
      <!-- Grid adjusts from 1 column (mobile) to 3 columns (desktop) -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Course Form Card (Fixed on the left/top) -->
        <div class="bg-white p-6 card rounded-xl lg:col-span-1 order-last lg:order-first">
          <h2 class="text-xl md:text-2xl font-bold text-gray-700 mb-4 border-b pb-2" id="course-form-title">افزودن درس جدید</h2>
          <form id="course-form" class="space-y-4">
            <input type="hidden" id="course-id">
            <div>
              <label for="course-name" class="block text-sm font-medium text-gray-700">نام درس</label>
              <input type="text" id="course-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
            </div>
            <div>
              <label for="course-professor" class="block text-sm font-medium text-gray-700">نام استاد</label>
              <input type="text" id="course-professor" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="نام استاد درس (اختیاری)">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="course-units" class="block text-sm font-medium text-gray-700">تعداد واحد</label>
                <input type="number" id="course-units" min="0.5" step="0.5" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
              </div>
              <div>
                <label for="course-term" class="block text-sm font-medium text-gray-700">ترم</label>
                <select id="course-term" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                  <option value="">ترم را انتخاب کنيد</option>
                </select>
              </div>
            </div>
            <div>
              <label for="course-grade" class="block text-sm font-medium text-gray-700">نمره کسب شده (اختیاری)</label>
              <input type="number" id="course-grade" min="0" max="20" step="0.01" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="برای محاسبه معدل، نمره را وارد کنید.">
            </div>
            <div>
              <label for="course-description" class="block text-sm font-medium text-gray-700">توضیحات (اختیاری)</label>
              <textarea id="course-description" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="یادداشت‌های شخصی، منابع مهم یا نکات کلیدی"></textarea>
            </div>
            <button type="submit" id="add-course-btn" class="btn-primary text-white py-3 px-4 rounded-lg w-full text-sm md:text-base">
              <i class="fas fa-plus ml-2"></i>اضافه کردن درس
            </button>
            <button type="button" id="cancel-edit-btn" onclick="resetCourseForm()" class="btn-secondary text-white py-3 px-4 rounded-lg w-full hidden text-sm md:text-base">
              <i class="fas fa-times ml-2"></i>انصراف از ویرایش
            </button>
          </form>
        </div>

        <!-- Courses List Card (Takes 2 columns on desktop) -->
        <div class="bg-white p-6 card rounded-xl lg:col-span-2 order-first lg:order-last">
          <h2 class="text-xl md:text-2xl font-bold text-gray-700 mb-4 border-b pb-2">لیست دروس</h2>

          <!-- Filter -->
          <div class="mb-4 flex flex-col sm:flex-row sm:space-x-4 sm:space-x-reverse items-start sm:items-center">
            <label for="term-filter" class="text-sm font-medium text-gray-700 whitespace-nowrap mb-2 sm:mb-0">فیلتر ترم:</label>
            <select id="term-filter" onchange="renderCoursesList()" class="rounded-lg border-gray-300 shadow-sm p-2 border w-full sm:w-auto">
              <option value="all">همه ترم‌ها</option>
            </select>
          </div>

          <!-- Course Table (Wrapped for mobile horizontal scroll) -->
          <div class="overflow-x-auto custom-scroll">
            <table class="min-w-full bg-white rounded-lg border border-gray-200">
              <thead>
                <tr class="bg-gray-100 text-right text-gray-600 text-sm leading-normal">
                  <th class="py-3 px-4 md:px-6">نام درس</th>
                  <th class="py-3 px-4 md:px-6">استاد</th>
                  <th class="py-3 px-4 md:px-6">واحد</th>
                  <th class="py-3 px-4 md:px-6">ترم</th>
                  <th class="py-3 px-4 md:px-6">نمره</th>
                  <th class="py-3 px-4 md:px-6">وضعیت</th>
                  <th class="py-3 px-4 md:px-6">عملیات</th>
                </tr>
              </thead>
              <tbody class="text-gray-600 text-xs md:text-sm font-light" id="courses-list">
                <!-- Course data will be rendered here -->
                <tr><td colspan="7" class="text-center py-4">درسی یافت نشد.</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Course Details Modal (for Description) -->
          <div id="details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4">
              <h3 id="modal-course-name" class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2"></h3>
              <div class="space-y-3">
                <p class="text-sm"><span class="font-medium text-gray-600">استاد:</span> <span id="modal-course-professor"></span></p>
                <p class="text-sm"><span class="font-medium text-gray-600">ترم:</span> <span id="modal-course-term"></span></p>
                <p class="text-sm font-medium text-gray-700 border-t pt-3 mt-3">توضیحات:</p>
                <p id="modal-course-description" class="p-3 bg-gray-50 rounded-lg whitespace-pre-wrap text-gray-600"></p>
              </div>
              <button onclick="closeModal()" class="mt-6 btn-primary text-white py-2 px-4 rounded-lg w-full">بستن</button>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- 3. Weekly Schedule Tab -->
    <section id="weekly" class="tab-content hidden">
      <div class="bg-white p-6 card rounded-xl">
          <h2 class="text-xl md:text-2xl font-bold text-gray-700 mb-4 border-b pb-2">برنامه‌ریزی هفتگی</h2>

          <!-- Filter -->
          <div class="mb-6 flex flex-col sm:flex-row sm:space-x-4 sm:space-x-reverse items-start sm:items-center">
            <label for="weekly-term-filter" class="text-sm font-medium text-gray-700 whitespace-nowrap mb-2 sm:mb-0">فیلتر ترم:</label>
            <select id="weekly-term-filter" onchange="renderWeeklySchedule()" class="rounded-lg border-gray-300 shadow-sm p-2 border w-full sm:w-auto">
              <option value="all">همه ترم‌ها</option>
            </select>
          </div>

          <!-- Schedule Setup Form -->
          <h3 class="text-lg md:text-xl font-semibold text-gray-700 mb-3">اضافه کردن زمان‌بندی هفتگی برای درس</h3>
          <form id="schedule-form" class="space-y-4 mb-6 p-4 border rounded-lg bg-gray-50">
            <div>
              <label for="schedule-course" class="block text-sm font-medium text-gray-700">درس</label>
              <select id="schedule-course" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                <option value="">درس را انتخاب کنيد</option>
              </select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <label for="schedule-day" class="block text-sm font-medium text-gray-700">روز</label>
                <select id="schedule-day" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                  <option value="">روز را انتخاب کنيد</option>
                  <option value="شنبه">شنبه</option>
                  <option value="یکشنبه">یکشنبه</option>
                  <option value="دوشنبه">دوشنبه</option>
                  <option value="سه‌شنبه">سه‌شنبه</option>
                  <option value="چهارشنبه">چهارشنبه</option>
                  <option value="پنجشنبه">پنجشنبه</option>
                  <option value="جمعه">جمعه</option>
                </select>
              </div>
              <div class="col-span-1 sm:col-span-2">
                <label for="schedule-start-time" class="block text-sm font-medium text-gray-700">ساعت شروع</label>
                <!-- Using a single time input for simplicity on mobile -->
                <input type="time" id="schedule-start-time" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
              </div>
              <input type="hidden" id="schedule-end-time" value="00:00">
            </div>
            <button type="submit" class="btn-primary text-white py-3 px-4 rounded-lg w-full text-sm md:text-base">
              <i class="fas fa-clock ml-2"></i>ثبت برنامه
            </button>
          </form>


          <!-- Weekly Schedule Table (Wrapped for mobile horizontal scroll) -->
          <div class="overflow-x-auto custom-scroll">
            <table class="min-w-full bg-white rounded-lg border border-gray-200">
              <thead>
                <tr class="bg-gray-100 text-right text-gray-600 text-xs md:text-sm leading-normal whitespace-nowrap">
                  <th class="py-3 px-3 md:px-6 w-1/7">شنبه</th>
                  <th class="py-3 px-3 md:px-6 w-1/7">یکشنبه</th>
                  <th class="py-3 px-3 md:px-6 w-1/7">دوشنبه</th>
                  <th class="py-3 px-3 md:px-6 w-1/7">سه‌شنبه</th>
                  <th class="py-3 px-3 md:px-6 w-1/7">چهارشنبه</th>
                  <th class="py-3 px-3 md:px-6 w-1/7">پنجشنبه</th>
                  <th class="py-3 px-3 md:px-6 w-1/7">جمعه</th>
                </tr>
              </thead>
              <tbody class="text-gray-600 text-xs font-light" id="weekly-schedule-body">
                <!-- Schedule data will be rendered here (one row representing all days) -->
              </tbody>
            </table>
          </div>

      </div>
    </section>
    
    <!-- 4. Exams and Events Tab -->
    <section id="exams" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Exam/Event Creation Form -->
            <div class="bg-white p-6 card rounded-xl lg:col-span-1 order-last lg:order-first">
                <h2 class="text-xl md:text-2xl font-bold text-gray-700 mb-4 border-b pb-2">ثبت رویداد جدید</h2>
                <form id="exam-form" class="space-y-4">
                    <input type="hidden" id="exam-id">
                    <div>
                        <label for="exam-course" class="block text-sm font-medium text-gray-700">درس مرتبط</label>
                        <select id="exam-course" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <option value="">درس را انتخاب کنيد</option>
                        </select>
                    </div>
                    <div>
                        <label for="exam-type" class="block text-sm font-medium text-gray-700">نوع رویداد</label>
                        <select id="exam-type" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <option value="نهایی">امتحان نهایی</option>
                            <option value="میان‌ترم">میان‌ترم</option>
                            <option value="کوییز">کوییز/پرسش کلاسی</option>
                            <option value="پروژه">پروژه/تکلیف</option>
                            <option value="سایر">سایر</option>
                        </select>
                    </div>
                    <div>
                        <label for="exam-name" class="block text-sm font-medium text-gray-700">توضیح/نام (اختیاری)</label>
                        <input type="text" id="exam-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="مثلاً: کوئیز فصل اول">
                    </div>
                    <div>
                        <label for="exam-date" class="block text-sm font-medium text-gray-700">تاریخ رویداد</label>
                        <input type="date" id="exam-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="exam-weight" class="block text-sm font-medium text-gray-700">وزن در نمره نهایی درس (درصد)</label>
                        <input type="number" id="exam-weight" min="0" max="100" step="1" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="مثال: ۴۰">
                    </div>
                    <button type="submit" id="add-exam-btn" class="btn-primary text-white py-3 px-4 rounded-lg w-full text-sm md:text-base">
                        <i class="fas fa-plus ml-2"></i>ثبت رویداد
                    </button>
                    <button type="button" id="cancel-exam-edit-btn" onclick="resetExamForm()" class="btn-secondary text-white py-3 px-4 rounded-lg w-full hidden text-sm md:text-base">
                        <i class="fas fa-times ml-2"></i>انصراف از ویرایش
                    </button>
                </form>
            </div>
            
            <!-- Exams/Events List -->
            <div class="bg-white p-6 card rounded-xl lg:col-span-2 order-first lg:order-last">
                <h2 class="text-xl md:text-2xl font-bold text-gray-700 mb-4 border-b pb-2">رویدادها و امتحانات پیش‌رو</h2>
                
                <div class="mb-4 flex flex-col sm:flex-row sm:space-x-4 sm:space-x-reverse items-start sm:items-center">
                    <label for="exam-term-filter" class="text-sm font-medium text-gray-700 whitespace-nowrap mb-2 sm:mb-0">فیلتر ترم:</label>
                    <select id="exam-term-filter" onchange="renderExamsList()" class="rounded-lg border-gray-300 shadow-sm p-2 border w-full sm:w-auto">
                      <option value="all">همه ترم‌ها</option>
                    </select>
                </div>
                
                <div id="exams-list" class="space-y-4">
                    <p class="text-center py-4 text-gray-500">هیچ رویدادی برای نمایش وجود ندارد.</p>
                    <!-- Exam/Event Cards will be rendered here -->
                </div>
            </div>
            
        </div>
    </section>

  </div> <!-- End of Dashboard View -->


<!-- Firebase and Application Logic -->
<script type="module">
  // --- Firebase Setup ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    sendPasswordResetEmail,
    signOut 
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    collection, 
    onSnapshot, 
    setDoc, 
    updateDoc, 
    deleteDoc, 
    setLogLevel 
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- HARDCODED FIREBASE CONFIGURATION ---
  const firebaseConfig = {
    apiKey: "AIzaSyB5qX596rhI5tszzF_k2B3fX95lIvR_eDE",
    authDomain: "student-4f362.firebaseapp.com",
    projectId: "student-4f362",
    storageBucket: "student-4f362.firebasestorage.app",
    messagingSenderId: "256541012363",
    appId: "1:256541012363:web:d7e629ec248d11bce13f8e",
    measurementId: "G-JZ69LTL6EF"
  };
  const appId = firebaseConfig.appId;
  // ----------------------------------------

  let app, db, auth;
  let userId = null;
  let userEmail = null; 
  let courses = [];
  let terms = [];

  // Utility function to show custom messages (replaces alert())
  function displayMessage(message, type = 'info') {
    const box = document.getElementById('message-box');
    box.textContent = message;
    // Ensure box resets position and visibility for mobile UX
    box.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 p-3 md:p-4 rounded-lg shadow-xl text-white font-medium text-sm md:text-base transition-all duration-300';
    
    if (type === 'success') {
      box.classList.add('bg-green-500');
    } else if (type === 'error') {
      box.classList.add('bg-red-500');
    } else {
      box.classList.add('bg-indigo-500');
    }
    
    box.classList.remove('hidden');
    
    setTimeout(() => {
      box.classList.add('hidden');
    }, 4000);
  }

  /**
   * Toggles the visibility of the password field.
   * @param {string} inputId - The ID of the password input field.
   */
  window.togglePasswordVisibility = function(inputId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(`${inputId}-toggle`);

      if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
      } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
      }
  }

  /**
   * Generates the secure, user-scoped Firestore path for a collection.
   * @param {string} collectionName - The name of the sub-collection (e.g., 'courses').
   */
  function getUserCollectionRef(collectionName) {
    if (!userId) {
      console.error("User ID is not set. Cannot access Firestore.");
      return null;
    }
    // Private data path: /artifacts/{appId}/users/{userId}/{collectionName}
    return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
  }


  // --- View Management ---

  /**
   * Switches between Auth View and Dashboard View.
   * @param {string} view - 'auth' or 'dashboard'.
   */
  function switchView(view) {
      document.getElementById('auth-view').classList.toggle('hidden', view === 'dashboard');
      document.getElementById('dashboard-view').classList.toggle('hidden', view === 'auth');
  }

  /**
   * Switches between login, register, and forgot password forms.
   * @param {string} form - 'login', 'register', or 'forgot-password'.
   */
  window.showAuthForm = function(form) {
      document.getElementById('login-form-container').classList.add('hidden');
      document.getElementById('register-form-container').classList.add('hidden');
      document.getElementById('forgot-password-container').classList.add('hidden');

      if (form === 'login') {
          document.getElementById('login-form-container').classList.remove('hidden');
      } else if (form === 'register') {
          document.getElementById('register-form-container').classList.remove('hidden');
      } else if (form === 'forgot-password') {
          document.getElementById('forgot-password-container').classList.remove('hidden');
      }
  }

  // --- Firebase Authentication ---

  /**
   * Initializes Firebase and sets up the Auth State Listener.
   */
  function setupFirebase() {
    try {
      app = initializeApp(firebaseConfig); 
      db = getFirestore(app);
      auth = getAuth(app);
      setLogLevel('debug');
      
      document.getElementById('loading-text').textContent = 'بررسی وضعیت ورود...';
      
      onAuthStateChanged(auth, (user) => {
        if (user) {
          userId = user.uid;
          userEmail = user.email;
          console.log("User authenticated:", userId);
          document.getElementById('user-info-display').innerHTML = `
              <span class="text-indigo-600 font-semibold">${userEmail}</span>
              <span class="text-gray-400 block sm:inline"> | UID: ${userId.substring(0, 8)}...</span>
          `;
          switchView('dashboard');
          loadAllDataListeners(); 
        } else {
          userId = null;
          userEmail = null;
          console.log("User is signed out.");
          switchView('auth');
          courses = [];
          terms = [];
        }
        document.getElementById('loading-overlay').classList.add('hidden');
      });

    } catch (error) {
      console.error("Firebase setup error:", error);
      displayMessage(`خطای راه‌اندازی فایربیس: ${error.message}`, 'error');
      document.getElementById('loading-overlay').classList.add('hidden');
    }
  }
  
  // Login handler
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    document.getElementById('loading-overlay').classList.remove('hidden');
    document.getElementById('loading-text').textContent = 'در حال ورود...';
    try {
      await signInWithEmailAndPassword(auth, email, password);
      displayMessage('با موفقیت وارد شدید!', 'success');
    } catch (error) {
      console.error("Login error:", error);
      let errorMessage = 'خطای ورود. لطفا ایمیل یا رمز عبور را بررسی کنید.';
      if (error.code === 'auth/operation-not-allowed') {
        errorMessage = 'خطای پیکربندی فایربیس. لطفا در کنسول فایربیس، روش ورود با "ایمیل/رمز عبور" را فعال کنید.';
      }
      displayMessage(errorMessage, 'error');
    } finally {
        document.getElementById('loading-overlay').classList.add('hidden');
    }
  });

  // Register handler
  document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    document.getElementById('loading-overlay').classList.remove('hidden');
    document.getElementById('loading-text').textContent = 'در حال ثبت نام...';
    try {
      await createUserWithEmailAndPassword(auth, email, password);
      displayMessage('ثبت نام با موفقیت انجام شد! وارد شدید.', 'success');
      showAuthForm('login');
    } catch (error) {
      console.error("Registration error:", error);
      let errorMessage = 'خطا در ثبت نام. لطفا مجددا تلاش کنید.';
      if (error.code === 'auth/email-already-in-use') {
        errorMessage = 'این ایمیل قبلاً ثبت نام شده است.';
      } else if (error.code === 'auth/operation-not-allowed') {
        errorMessage = 'خطای پیکربندی فایربیس. لطفا در کنسول فایربیس، روش ورود با "ایمیل/رمز عبور" را فعال کنید.';
      }
      displayMessage(errorMessage, 'error');
    } finally {
        document.getElementById('loading-overlay').classList.add('hidden');
    }
  });
  
  // Forgot Password handler
  document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('forgot-email').value;
    document.getElementById('loading-overlay').classList.remove('hidden');
    document.getElementById('loading-text').textContent = 'در حال ارسال ایمیل...';
    try {
      await sendPasswordResetEmail(auth, email);
      displayMessage(`لینک بازیابی رمز عبور به ایمیل ${email} ارسال شد.`, 'success');
      showAuthForm('login');
    } catch (error) {
      console.error("Password reset error:", error);
      displayMessage('خطا در ارسال ایمیل. لطفا ایمیل را بررسی کنید.', 'error');
    } finally {
        document.getElementById('loading-overlay').classList.add('hidden');
    }
  });
  
  window.signOutUser = async function() {
      try {
          await signOut(auth);
          displayMessage('با موفقیت خارج شدید.', 'info');
      } catch (error) {
          console.error("Sign out error:", error);
          displayMessage('خطا در خروج از حساب کاربری.', 'error');
      }
  }

  // --- Real-Time Data Listeners ---

  function loadAllDataListeners() {
    if (!userId) return;

    // 1. Courses Listener
    onSnapshot(getUserCollectionRef('courses'), (snapshot) => {
      courses = snapshot.docs.map(doc => ({ 
        id: doc.id, 
        ...doc.data(),
        // Ensure schedule and exams are arrays upon load
        schedule: Array.isArray(doc.data().schedule) ? doc.data().schedule : [],
        exams: Array.isArray(doc.data().exams) ? doc.data().exams : [] 
      }));
      console.log("Courses updated:", courses.length);
      renderCoursesList();
      calculateGPA();
      renderWeeklySchedule();
      loadCourseOptions(); 
      renderExamsList(); 
      loadExamCourseOptions();
    }, (error) => {
      console.error("Error listening to courses:", error);
      displayMessage("خطا در دريافت ليست دروس.", 'error');
    });

    // 2. Terms Listener
    onSnapshot(getUserCollectionRef('terms'), (snapshot) => {
      terms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
      console.log("Terms updated:", terms.length);
      renderTermsList();
      loadTermOptions(); 
      calculateGPA(); 
      renderExamsList();
    }, (error) => {
      console.error("Error listening to terms:", error);
      displayMessage("خطا در دريافت ليست ترم‌ها.", 'error');
    });
  }

  // --- Data Display and Calculation Functions ---

  /**
   * Renders the list of active terms in the management card.
   */
  window.renderTermsList = function() {
    const listElement = document.getElementById('term-list');
    listElement.innerHTML = '';

    if (terms.length === 0) {
      listElement.innerHTML = '<li class="text-gray-500 text-sm">ترم فعالی تعریف نشده است.</li>';
      return;
    }

    terms.forEach(term => {
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-150';
      li.innerHTML = `
        <span class="text-gray-700 font-medium">${term.name}</span>
        <button onclick="deleteTerm('${term.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full" title="حذف ترم">
          <i class="fas fa-trash-alt text-xs"></i>
        </button>
      `;
      listElement.appendChild(li);
    });
  };

  /**
   * Updates term filter and course term dropdowns based on loaded terms.
   */
  window.loadTermOptions = function() {
    const termFilter = document.getElementById('term-filter');
    const weeklyTermFilter = document.getElementById('weekly-term-filter');
    const examTermFilter = document.getElementById('exam-term-filter'); 
    const courseTerm = document.getElementById('course-term');

    // Store current selections
    const selectedTermFilter = termFilter.value;
    const selectedWeeklyFilter = weeklyTermFilter.value;
    const selectedExamFilter = examTermFilter.value; 
    const selectedCourseTerm = courseTerm.value;


    [termFilter, weeklyTermFilter, examTermFilter, courseTerm].forEach(select => { 
      select.innerHTML = ''; 
    });

    // Add default options
    [termFilter, weeklyTermFilter, examTermFilter].forEach(select => { 
        const defaultOption = document.createElement('option');
        defaultOption.value = 'all';
        defaultOption.textContent = 'همه ترم‌ها';
        select.appendChild(defaultOption);
    });
    
    const courseTermDefault = document.createElement('option');
    courseTermDefault.value = '';
    courseTermDefault.textContent = 'ترم را انتخاب کنيد';
    courseTerm.appendChild(courseTermDefault);


    // Populate with terms
    terms.forEach(term => {
      const option1 = document.createElement('option');
      option1.value = term.name;
      option1.textContent = term.name;
      
      const option2 = option1.cloneNode(true);
      const option3 = option1.cloneNode(true);
      const option4 = option1.cloneNode(true);

      termFilter.appendChild(option1);
      weeklyTermFilter.appendChild(option2);
      examTermFilter.appendChild(option3); 
      courseTerm.appendChild(option4);
    });

    // Restore selections
    termFilter.value = selectedTermFilter;
    weeklyTermFilter.value = selectedWeeklyFilter;
    examTermFilter.value = selectedExamFilter; 
    courseTerm.value = selectedCourseTerm;
  };
  
  /**
   * Renders the list of courses based on the current term filter.
   */
  window.renderCoursesList = function() {
    const listElement = document.getElementById('courses-list');
    const filter = document.getElementById('term-filter').value;

    const filteredCourses = courses.filter(course => 
      filter === 'all' || course.term === filter
    );

    listElement.innerHTML = '';

    if (filteredCourses.length === 0) {
      listElement.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">درسی در این ترم یافت نشد.</td></tr>';
      return;
    }

    filteredCourses.forEach(course => {
      const grade = course.grade || '---';
      const isPassed = course.grade >= 10;
      const statusText = course.grade ? (isPassed ? 'قبول' : 'رد') : 'ناقص';
      const statusClass = course.grade ? (isPassed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') : 'bg-yellow-100 text-yellow-800';
      const professor = course.professor || '---';

      const row = document.createElement('tr');
      row.className = 'border-b border-gray-200 hover:bg-gray-50';
      
      row.innerHTML = `
        <td class="py-2 px-4 text-right whitespace-nowrap">${course.name}</td>
        <td class="py-2 px-4 text-right whitespace-nowrap">${professor}</td>
        <td class="py-2 px-4 text-right">${course.units}</td>
        <td class="py-2 px-4 text-right">${course.term}</td>
        <td class="py-2 px-4 text-right font-bold">${grade}</td>
        <td class="py-2 px-4 text-right">
          <span class="relative inline-block px-2 py-0.5 font-semibold leading-tight">
            <span aria-hidden class="absolute inset-0 opacity-50 rounded-full ${statusClass}"></span>
            <span class="relative text-[0.6rem] md:text-xs">${statusText}</span>
          </span>
        </td>
        <td class="py-2 px-4 text-right">
          <div class="flex item-center justify-start space-x-2 space-x-reverse">
            <button onclick="showDetailsModal('${course.id}')" class="p-1 transform hover:text-blue-500 hover:scale-110" title="مشاهده جزئیات/توضیحات">
              <i class="fas fa-info-circle text-sm"></i>
            </button>
            <button onclick="startEditCourse('${course.id}')" class="p-1 transform hover:text-indigo-500 hover:scale-110" title="ویرایش">
              <i class="fas fa-edit text-sm"></i>
            </button>
            <button onclick="deleteCourse('${course.id}')" class="p-1 transform hover:text-red-500 hover:scale-110" title="حذف">
              <i class="fas fa-trash-alt text-sm"></i>
            </button>
          </div>
        </td>
      `;
      listElement.appendChild(row);
    });
  };

  /**
   * Calculates and displays the overall GPA and term GPAs.
   */
  window.calculateGPA = function() {
    let totalWeightedPoints = 0;
    let totalUnitsAttempted = 0;
    let totalUnitsPassed = 0;
    const termGPAs = {};
    
    courses.forEach(course => {
      const units = parseFloat(course.units);
      const grade = parseFloat(course.grade);

      if (units > 0) {
        totalUnitsAttempted += units;
        
        if (!isNaN(grade)) {
          totalWeightedPoints += grade * units;

          if (grade >= 10) {
            totalUnitsPassed += units;
          }

          if (!termGPAs[course.term]) {
            termGPAs[course.term] = { weightedPoints: 0, units: 0 };
          }
          termGPAs[course.term].weightedPoints += grade * units;
          termGPAs[course.term].units += units;
        }
      }
    });

    const totalGPA = totalUnitsAttempted > 0 ? (totalWeightedPoints / totalUnitsAttempted).toFixed(2) : '--';
    document.getElementById('total-gpa').textContent = totalGPA;
    document.getElementById('total-units').textContent = totalUnitsAttempted.toFixed(1);
    document.getElementById('passed-units').textContent = totalUnitsPassed.toFixed(1);

    const termListBody = document.getElementById('terms-gpa-list');
    termListBody.innerHTML = '';
    
    const sortedTermNames = terms.map(t => t.name);

    if (sortedTermNames.length === 0) {
        termListBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">هیچ داده‌ای برای محاسبه معدل ترم‌ها وجود ندارد.</td></tr>';
        return;
    }

    sortedTermNames.forEach(termName => {
      const termData = termGPAs[termName];
      if (termData && termData.units > 0) { 
        const gpa = (termData.weightedPoints / termData.units).toFixed(2);
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-gray-50';
        row.innerHTML = `
          <td class="py-3 px-4 md:px-6">${termName}</td>
          <td class="py-3 px-4 md:px-6">${termData.units.toFixed(1)}</td>
          <td class="py-3 px-4 md:px-6 font-bold">${gpa}</td>
        `;
        termListBody.appendChild(row);
      }
    });
    
    if (termListBody.children.length === 0) {
      termListBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">نمره‌ای برای محاسبه معدل ترم‌ها ثبت نشده است.</td></tr>';
    }
  };

  /**
   * Updates the course selection dropdowns for scheduling.
   */
  window.loadCourseOptions = function() {
    const select = document.getElementById('schedule-course');
    const selectedCourseId = select.value; 
    select.innerHTML = '<option value="">درس را انتخاب کنيد</option>';
    
    const coursesWithTerm = courses.filter(c => c.term);

    coursesWithTerm.forEach(course => {
      const option = document.createElement('option');
      option.value = course.id; 
      option.textContent = `${course.name} (${course.term})`;
      select.appendChild(option);
    });

    if (coursesWithTerm.some(c => c.id === selectedCourseId)) {
        select.value = selectedCourseId;
    }
  };
  
  /**
   * Updates the course selection dropdowns for the Exam/Event form.
   */
  window.loadExamCourseOptions = function() {
    const select = document.getElementById('exam-course');
    const selectedCourseId = select.value; 
    select.innerHTML = '<option value="">درس را انتخاب کنيد</option>';
    
    const coursesWithTerm = courses.filter(c => c.term);

    coursesWithTerm.forEach(course => {
      const option = document.createElement('option');
      option.value = course.id; 
      option.textContent = `${course.name} (${course.term})`;
      select.appendChild(option);
    });

    if (coursesWithTerm.some(c => c.id === selectedCourseId)) {
        select.value = selectedCourseId;
    }
  };
  
  /**
   * Renders the weekly schedule table based on filtered courses.
   */
  window.renderWeeklySchedule = function() {
      const body = document.getElementById('weekly-schedule-body');
      const termFilter = document.getElementById('weekly-term-filter').value;
      body.innerHTML = '';
      
      const daysOfWeek = ["شنبه", "یکشنبه", "دوشنبه", "سه‌شنبه", "چهارشنبه", "پنجشنبه", "جمعه"];
      const scheduleByDay = daysOfWeek.map(() => []);

      courses.forEach(course => {
          if (termFilter !== 'all' && course.term !== termFilter) return;

          if (Array.isArray(course.schedule)) {
              course.schedule.forEach(item => {
                  const dayIndex = daysOfWeek.indexOf(item.day);
                  if (dayIndex !== -1) {
                      scheduleByDay[dayIndex].push({
                          ...item,
                          courseName: course.name,
                          courseId: course.id,
                          courseTerm: course.term
                      });
                  }
              });
          }
      });

      // Sort items within each day by start time
      scheduleByDay.forEach(dayList => {
          dayList.sort((a, b) => a.time.localeCompare(b.time));
      });

      const maxItemsPerDay = scheduleByDay.reduce((max, day) => Math.max(max, day.length), 0);

      if (maxItemsPerDay === 0) {
          body.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-500">
              برنامه‌ هفتگی برای دروس فیلتر شده ثبت نشده است.
          </td></tr>`;
          return;
      }

      for (let i = 0; i < maxItemsPerDay; i++) {
          const row = document.createElement('tr');
          row.className = 'border-b border-gray-100 hover:bg-gray-50';
          
          daysOfWeek.forEach((day, dayIndex) => {
              const td = document.createElement('td');
              td.className = 'py-3 px-3 md:px-6 align-top';
              
              const item = scheduleByDay[dayIndex][i];
              
              if (item) {
                  td.innerHTML = `
                      <div class="p-2 rounded-lg bg-indigo-50 border border-indigo-200 shadow-sm text-right">
                          <p class="font-bold text-indigo-800 text-xs md:text-sm whitespace-normal">${item.courseName}</p>
                          <p class="text-[0.6rem] text-gray-600 mt-1">${item.time}</p>
                          <button onclick="deleteScheduleItem('${item.courseId}', '${item.id}')" 
                                  class="text-red-500 hover:text-red-700 mt-1" 
                                  title="حذف برنامه">
                              <i class="fas fa-times-circle text-xs"></i>
                          </button>
                      </div>
                  `;
              } else {
                  td.innerHTML = '&nbsp;'; // Empty cell
              }
              row.appendChild(td);
          });
          body.appendChild(row);
      }
  };

  /**
   * Shows the course details modal.
   */
  window.showDetailsModal = function(id) {
    const course = courses.find(c => c.id === id);
    if (!course) return;

    document.getElementById('modal-course-name').textContent = course.name;
    document.getElementById('modal-course-professor').textContent = course.professor || 'نامشخص';
    document.getElementById('modal-course-term').textContent = course.term || 'نامشخص';
    document.getElementById('modal-course-description').textContent = course.description || 'توضیحات خاصی ثبت نشده است.';
    
    document.getElementById('details-modal').classList.remove('hidden');
  };

  /**
   * Closes the modal.
   */
  window.closeModal = function() {
    document.getElementById('details-modal').classList.add('hidden');
  };


  // --- CRUD Operations (Terms) ---

  document.getElementById('term-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!userId) {
        displayMessage('لطفا ابتدا وارد شوید.', 'error');
        return;
    }

    const name = document.getElementById('new-term-name').value.trim();
    if (!name) {
        displayMessage('نام ترم نمی‌تواند خالی باشد.', 'error');
        return;
    }
    
    // Check for duplicate names
    if (terms.some(t => t.name === name)) {
        displayMessage('این ترم قبلاً اضافه شده است.', 'error');
        return;
    }

    const termData = {
        name: name,
        timestamp: Date.now()
    };

    try {
        await setDoc(doc(getUserCollectionRef('terms'), name), termData); // Use name as document ID for easy reference
        displayMessage('ترم با موفقیت اضافه شد.', 'success');
        document.getElementById('new-term-name').value = '';
    } catch (error) {
        console.error("Error adding term:", error);
        displayMessage(`خطا در ذخیره ترم: ${error.message}`, 'error');
    }
  });

  window.deleteTerm = async function(id) {
    if (!userId) return;

    if (!window.confirm("آیا مطمئن هستید که می‌خواهید این ترم را حذف کنید؟ این کار تمام دروس مرتبط با این ترم را حذف نمی‌کند، اما دروس بدون ترم در محاسبه معدل نادیده گرفته می‌شوند.")) {
        return;
    }

    try {
        await deleteDoc(doc(getUserCollectionRef('terms'), id));
        displayMessage('ترم با موفقیت حذف شد.', 'success');
    } catch (error) {
        console.error("Error deleting term:", error);
        displayMessage(`خطا در حذف ترم: ${error.message}`, 'error');
    }
  };


  // --- CRUD Operations (Courses) ---

  /**
   * Handles adding/editing a course.
   */
  document.getElementById('course-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!userId) {
      displayMessage('لطفا ابتدا وارد شوید.', 'error');
      return;
    }

    const id = document.getElementById('course-id').value;
    const name = document.getElementById('course-name').value;
    const professor = document.getElementById('course-professor').value.trim() || null;
    const units = parseFloat(document.getElementById('course-units').value);
    const term = document.getElementById('course-term').value;
    const gradeInput = document.getElementById('course-grade').value;
    const grade = gradeInput ? parseFloat(gradeInput) : null;
    const description = document.getElementById('course-description').value.trim() || null;

    if (term === "") {
        displayMessage('لطفاً ترم را انتخاب کنید.', 'error');
        return;
    }

    let courseData = {
      name, professor, units, term, grade, description, timestamp: Date.now() 
    };
    
    // Preserve existing arrays (schedule, exams) if editing an existing course
    if (id) {
        const existingCourse = courses.find(c => c.id === id);
        if (existingCourse) {
            courseData.schedule = existingCourse.schedule || [];
            courseData.exams = existingCourse.exams || []; // Include exams array
        }
    } else {
        // Initialize arrays for new course
        courseData.schedule = [];
        courseData.exams = [];
    }
    

    try {
      if (id) {
        // Edit existing course
        await updateDoc(doc(getUserCollectionRef('courses'), id), courseData);
        displayMessage('درس با موفقیت ویرایش شد.', 'success');
      } else {
        // Add new course
        await setDoc(doc(getUserCollectionRef('courses')), courseData);
        displayMessage('درس با موفقیت اضافه شد.', 'success');
      }
      
      resetCourseForm();

    } catch (error) {
      console.error("Error saving course:", error);
      displayMessage(`خطا در ذخیره درس: ${error.message}`, 'error');
    }
  });
  
  /**
   * Starts the editing process for a course, populating the form.
   */
  window.startEditCourse = function(id) {
    const course = courses.find(c => c.id === id);
    if (!course) return;

    document.getElementById('course-id').value = course.id;
    document.getElementById('course-name').value = course.name;
    document.getElementById('course-professor').value = course.professor || '';
    document.getElementById('course-units').value = course.units;
    document.getElementById('course-term').value = course.term;
    document.getElementById('course-grade').value = course.grade || '';
    document.getElementById('course-description').value = course.description || '';

    document.getElementById('course-form-title').textContent = 'ویرایش درس';
    document.getElementById('add-course-btn').innerHTML = '<i class="fas fa-save"></i> ذخیره تغییرات';
    document.getElementById('cancel-edit-btn').classList.remove('hidden');
    
    document.getElementById('course-form').scrollIntoView({ behavior: 'smooth' });
  };

  /**
   * Resets the course form to the 'Add New' state.
   * IMPROVED: Explicitly clears ALL form fields for robust reset.
   */
  window.resetCourseForm = function() {
    const form = document.getElementById('course-form');
    // 1. Use built-in reset
    form.reset();
    
    // 2. Explicitly clear fields for cross-browser reliability
    document.getElementById('course-id').value = '';
    document.getElementById('course-name').value = '';
    document.getElementById('course-professor').value = '';
    document.getElementById('course-units').value = '';
    document.getElementById('course-term').value = '';
    document.getElementById('course-grade').value = '';
    document.getElementById('course-description').value = '';
    
    // 3. Reset UI state
    document.getElementById('course-form-title').textContent = 'افزودن درس جدید';
    document.getElementById('add-course-btn').innerHTML = '<i class="fas fa-plus"></i> اضافه کردن درس';
    document.getElementById('cancel-edit-btn').classList.add('hidden');
  };
  
  /**
   * Deletes a course.
   */
  window.deleteCourse = async function(id) {
    if (!userId) return;

    if (!window.confirm("آیا مطمئن هستید که می‌خواهید این درس را حذف کنید؟ این عمل غیرقابل بازگشت است.")) {
        return;
    }

    try {
        await deleteDoc(doc(getUserCollectionRef('courses'), id));
        displayMessage('درس با موفقیت حذف شد.', 'success');
        resetCourseForm();
    } catch (error) {
        console.error("Error deleting course:", error);
        displayMessage(`خطا در حذف درس: ${error.message}`, 'error');
    }
  };


  // --- CRUD Operations (Weekly Schedule) ---

  document.getElementById('schedule-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!userId) {
        displayMessage('لطفا ابتدا وارد شوید.', 'error');
        return;
    }

    const courseId = document.getElementById('schedule-course').value;
    const day = document.getElementById('schedule-day').value;
    const time = document.getElementById('schedule-start-time').value;
    
    if (!courseId || !day || !time) {
        displayMessage('لطفاً درس، روز و ساعت را انتخاب کنید.', 'error');
        return;
    }
    
    const course = courses.find(c => c.id === courseId);
    if (!course) return;

    const newScheduleItem = {
      id: crypto.randomUUID(),
      day,
      time
    };
    
    // Check for existing schedule item for the same day/time in the same course
    if (Array.isArray(course.schedule) && course.schedule.some(item => item.day === day && item.time === time)) {
        displayMessage('این درس قبلاً برای این روز و ساعت ثبت شده است.', 'error');
        return;
    }
    
    const updatedSchedule = Array.isArray(course.schedule) ? [...course.schedule, newScheduleItem] : [newScheduleItem];

    try {
      await updateDoc(doc(getUserCollectionRef('courses'), courseId), {
        schedule: updatedSchedule
      });
      
      displayMessage('برنامه هفتگی با موفقیت ثبت شد.', 'success');
      document.getElementById('schedule-form').reset();
    } catch (error) {
      console.error("Error adding schedule item:", error);
      displayMessage(`خطا در ثبت برنامه هفتگی: ${error.message}`, 'error');
    }
  });

  window.deleteScheduleItem = async function(courseId, scheduleId) {
    if (!userId) return;

    if (!window.confirm("آیا مطمئن هستید که می‌خواهید این زمان‌بندی را از برنامه هفتگی حذف کنید؟")) {
        return;
    }

    try {
        const course = courses.find(c => c.id === courseId);
        if (!course || !Array.isArray(course.schedule)) return;

        const updatedSchedule = course.schedule.filter(item => item.id !== scheduleId);

        await updateDoc(doc(getUserCollectionRef('courses'), courseId), {
            schedule: updatedSchedule
        });
        displayMessage('زمان‌بندی با موفقیت حذف شد.', 'success');
    } catch (error) {
        console.error("Error deleting schedule item:", error);
        displayMessage(`خطا در حذف زمان‌بندی: ${error.message}`, 'error');
    }
  };


  // --- CRUD Operations (Exams/Events) ---
  
  /**
   * Renders the list of exams and events.
   */
  window.renderExamsList = function() {
    const listElement = document.getElementById('exams-list');
    const termFilter = document.getElementById('exam-term-filter').value;
    
    // Flatten all exams from all courses into a single list
    let allExams = [];
    courses.forEach(course => {
        const isTermMatch = termFilter === 'all' || course.term === termFilter;
        if (Array.isArray(course.exams) && isTermMatch) {
            course.exams.forEach(exam => {
                allExams.push({
                    ...exam,
                    courseId: course.id,
                    courseName: course.name,
                    courseTerm: course.term
                });
            });
        }
    });

    // Sort by date (ascending)
    allExams.sort((a, b) => new Date(a.date) - new Date(b.date));

    listElement.innerHTML = '';

    if (allExams.length === 0) {
      listElement.innerHTML = '<p class="text-center py-4 text-gray-500">هیچ رویدادی برای نمایش وجود ندارد.</p>';
      return;
    }
    
    allExams.forEach(exam => {
        const isPast = new Date(exam.date) < new Date();
        const cardClass = isPast ? 'bg-gray-50 opacity-70 border-gray-200' : 'bg-white border-indigo-100 shadow-lg hover:shadow-xl transition-shadow';
        const typeIcon = getExamTypeIcon(exam.type);
        const dateText = exam.date.split('-').reverse().join('/'); // Simple date format change

        const card = document.createElement('div');
        card.className = `p-4 border rounded-xl flex justify-between items-center ${cardClass}`;
        card.innerHTML = `
            <div class="flex items-center space-x-4 space-x-reverse min-w-0 flex-grow">
                <!-- Icon & Type -->
                <div class="p-3 rounded-full ${isPast ? 'bg-gray-200 text-gray-600' : 'bg-indigo-100 text-indigo-600'} flex-shrink-0">
                    <i class="${typeIcon} text-lg"></i>
                </div>
                
                <!-- Details -->
                <div class="min-w-0 flex-grow">
                    <p class="font-bold text-base whitespace-nowrap overflow-hidden overflow-ellipsis">
                        ${exam.name ? `${exam.name} (${exam.type})` : exam.type}
                    </p>
                    <p class="text-xs text-gray-500 whitespace-nowrap overflow-hidden overflow-ellipsis">
                        ${exam.courseName} <span class="text-indigo-500 font-mono text-[0.6rem] ml-1">(${exam.courseTerm})</span>
                    </p>
                </div>
            </div>
            
            <!-- Date & Weight -->
            <div class="text-left flex-shrink-0 mr-4 space-x-4 space-x-reverse">
                <span class="font-bold text-sm text-gray-700 block">${dateText}</span>
                <span class="text-xs ${isPast ? 'text-gray-500' : 'text-green-600'} block text-center">${exam.weight}%</span>
            </div>

            <!-- Actions -->
            <div class="flex-shrink-0">
                <button onclick="deleteExam('${exam.courseId}', '${exam.id}')" 
                        class="p-1 text-red-500 hover:text-red-700 transition duration-150 rounded-full hover:bg-red-100 ml-2" 
                        title="حذف رویداد">
                    <i class="fas fa-trash-alt text-sm"></i>
                </button>
            </div>
        `;
        listElement.appendChild(card);
    });
  };
  
  /**
   * Gets a relevant Font Awesome icon for the exam type.
   */
  function getExamTypeIcon(type) {
      switch(type) {
          case 'نهایی': return 'fas fa-graduation-cap';
          case 'میان‌ترم': return 'fas fa-book';
          case 'کوییز': return 'fas fa-clipboard-question';
          case 'پروژه': return 'fas fa-laptop-code';
          default: return 'fas fa-circle-info';
      }
  }


  /**
   * Handles adding a new exam/event to a course.
   */
  document.getElementById('exam-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!userId) {
      displayMessage('لطفا ابتدا وارد شوید.', 'error');
      return;
    }

    const courseId = document.getElementById('exam-course').value;
    const type = document.getElementById('exam-type').value;
    const name = document.getElementById('exam-name').value.trim() || null;
    const date = document.getElementById('exam-date').value;
    const weight = parseInt(document.getElementById('exam-weight').value);
    
    if (!courseId || !type || !date || isNaN(weight)) {
        displayMessage('لطفاً تمام فیلدهای اصلی را پر کنید.', 'error');
        return;
    }
    
    const course = courses.find(c => c.id === courseId);
    if (!course) return;
    
    const newExamItem = {
      id: crypto.randomUUID(), // Unique ID for event
      type,
      name,
      date,
      weight,
      timestamp: Date.now()
    };
    
    const updatedExams = Array.isArray(course.exams) ? [...course.exams, newExamItem] : [newExamItem];

    try {
      await updateDoc(doc(getUserCollectionRef('courses'), courseId), {
        exams: updatedExams
      });
      
      displayMessage('رویداد/امتحان با موفقیت ثبت شد.', 'success');
      resetExamForm();
    } catch (error) {
      console.error("Error adding exam:", error);
      displayMessage(`خطا در ثبت رویداد: ${error.message}`, 'error');
    }
  });
  
  /**
   * Resets the exam form.
   */
  window.resetExamForm = function() {
      const form = document.getElementById('exam-form');
      form.reset();
      
      // Explicitly clear optional/hidden fields
      document.getElementById('exam-id').value = '';
      document.getElementById('exam-name').value = '';
      
      // Optionally reset the type selector to default
      document.getElementById('exam-type').value = 'نهایی';
      
      document.getElementById('cancel-exam-edit-btn').classList.add('hidden');
      document.getElementById('add-exam-btn').innerHTML = '<i class="fas fa-plus ml-2"></i>ثبت رویداد';
  };

  /**
   * Deletes a specific exam item from a course.
   */
  window.deleteExam = async function(courseId, examId) {
    if (!userId) return;

    if (!window.confirm("آیا مطمئن هستید که می‌خواهید این رویداد را حذف کنید؟")) {
        return;
    }

    try {
        const course = courses.find(c => c.id === courseId);
        if (!course || !Array.isArray(course.exams)) return;

        const updatedExams = course.exams.filter(item => item.id !== examId);

        await updateDoc(doc(getUserCollectionRef('courses'), courseId), {
            exams: updatedExams
        });
        displayMessage('رویداد با موفقیت حذف شد.', 'success');
    } catch (error) {
        console.error("Error deleting exam item:", error);
        displayMessage(`خطا در حذف رویداد: ${error.message}`, 'error');
    }
  };
  
  // --- Tab Management ---

  window.changeTab = function(tabId) {
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.add('hidden');
    });
    document.getElementById(tabId).classList.remove('hidden');

    document.querySelectorAll('.tab-button').forEach(button => {
      button.classList.remove('tab-active');
    });
    document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('tab-active');

    // Trigger renders when switching to ensure freshness
    if (tabId === 'overview') {
      calculateGPA();
    } else if (tabId === 'courses') {
      renderCoursesList();
    } else if (tabId === 'weekly') {
      renderWeeklySchedule(); 
    } else if (tabId === 'exams') { 
      renderExamsList();
      loadExamCourseOptions();
    }
  };

  // --- Initialize App ---
  window.onload = function() {
    setupFirebase();
  };
</script>
</body>
</html>
