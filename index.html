<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>صفحه کاربري دانشجويي</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vazirmatn Font -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4f46e5;
      --secondary-color: #10b981;
      --text-color: #1f2937;
    }
    body {
      font-family: "Vazirmatn", sans-serif;
      color: var(--text-color);
      background-color: #f3f4f6;
    }
    .btn-primary {
      background-color: var(--primary-color);
      transition: background-color 0.2s;
    }
    .btn-primary:hover {
      background-color: #4338ca;
    }
    .btn-secondary {
      background-color: var(--secondary-color);
      transition: background-color 0.2s;
    }
    .btn-secondary:hover {
      background-color: #059669;
    }
    .tab-active {
      border-color: var(--primary-color);
      color: var(--primary-color);
      font-weight: 700;
    }
    .card {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }
    .hidden { display: none !important; }

    /* Custom Scrollbar for better UX */
    .custom-scroll::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
        background-color: #9ca3af;
        border-radius: 10px;
    }
    .custom-scroll::-webkit-scrollbar-track {
        background: #e5e7eb;
    }

    /* Auth View specific styling */
    .auth-container {
        max-width: 450px;
        margin: 4rem auto;
    }
  </style>
</head>
<body class="p-4 md:p-8">

  <!-- Message Box (Used for all notifications) -->
  <div id="message-box" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 p-4 rounded-lg shadow-xl text-white font-medium hidden"></div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-2xl flex items-center space-x-3 space-x-reverse">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
      <p class="text-indigo-700 text-lg font-medium" id="loading-text">در حال راه‌اندازی...</p>
    </div>
  </div>


  <!-- Authentication View (Login, Register, Forgot Password) -->
  <div id="auth-view" class="auth-container">
    
    <div id="login-form-container" class="bg-white p-8 card rounded-xl transition duration-300">
        <h2 class="text-3xl font-bold text-indigo-700 mb-6 text-center">ورود به داشبورد</h2>
        <form id="login-form" class="space-y-4">
            <div>
                <label for="login-email" class="block text-sm font-medium text-gray-700">ایمیل</label>
                <input type="email" id="login-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
            </div>
            <div class="relative">
                <label for="login-password" class="block text-sm font-medium text-gray-700">رمز عبور</label>
                <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                <span onclick="togglePasswordVisibility('login-password')" class="absolute inset-y-0 left-0 flex items-center pl-3 cursor-pointer mt-6">
                    <i id="login-password-toggle" class="fas fa-eye text-gray-500 hover:text-indigo-600"></i>
                </span>
            </div>
            <button type="submit" class="btn-primary text-white py-3 px-4 rounded-lg w-full text-lg font-semibold">
                <i class="fas fa-sign-in-alt ml-2"></i>ورود
            </button>
        </form>
        <p class="mt-6 text-center text-sm">
            <button onclick="showAuthForm('register')" class="text-indigo-600 hover:text-indigo-800 font-medium">حساب کاربری ندارید؟ ثبت نام کنید</button>
        </p>
        <p class="mt-2 text-center text-sm">
            <button onclick="showAuthForm('forgot-password')" class="text-red-500 hover:text-red-700 font-medium">فراموشی رمز عبور</button>
        </p>
    </div>

    <!-- Registration Form -->
    <div id="register-form-container" class="bg-white p-8 card rounded-xl hidden transition duration-300">
        <h2 class="text-3xl font-bold text-indigo-700 mb-6 text-center">ثبت نام کاربر جدید</h2>
        <form id="register-form" class="space-y-4">
            <div>
                <label for="register-email" class="block text-sm font-medium text-gray-700">ایمیل</label>
                <input type="email" id="register-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
            </div>
            <div class="relative">
                <label for="register-password" class="block text-sm font-medium text-gray-700">رمز عبور (حداقل ۶ کاراکتر)</label>
                <input type="password" id="register-password" required minlength="6" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                <span onclick="togglePasswordVisibility('register-password')" class="absolute inset-y-0 left-0 flex items-center pl-3 cursor-pointer mt-6">
                    <i id="register-password-toggle" class="fas fa-eye text-gray-500 hover:text-indigo-600"></i>
                </span>
            </div>
            <button type="submit" class="btn-primary text-white py-3 px-4 rounded-lg w-full text-lg font-semibold">
                <i class="fas fa-user-plus ml-2"></i>ثبت نام
            </button>
        </form>
        <p class="mt-6 text-center text-sm">
            <button onclick="showAuthForm('login')" class="text-indigo-600 hover:text-indigo-800 font-medium">قبلاً ثبت نام کرده‌اید؟ ورود</button>
        </p>
    </div>

    <!-- Forgot Password Form -->
    <div id="forgot-password-container" class="bg-white p-8 card rounded-xl hidden transition duration-300">
        <h2 class="text-3xl font-bold text-indigo-700 mb-6 text-center">بازیابی رمز عبور</h2>
        <p class="text-center text-gray-600 mb-6">ایمیل خود را وارد کنید تا لینک بازیابی برایتان ارسال شود.</p>
        <form id="forgot-password-form" class="space-y-4">
            <div>
                <label for="forgot-email" class="block text-sm font-medium text-gray-700">ایمیل</label>
                <input type="email" id="forgot-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
            </div>
            <button type="submit" class="btn-primary text-white py-3 px-4 rounded-lg w-full text-lg font-semibold">
                <i class="fas fa-envelope ml-2"></i>ارسال لینک بازیابی
            </button>
        </form>
        <p class="mt-6 text-center text-sm">
            <button onclick="showAuthForm('login')" class="text-indigo-600 hover:text-indigo-800 font-medium">بازگشت به صفحه ورود</button>
        </p>
    </div>

  </div> <!-- End of Auth View -->


  <!-- Dashboard View (Hidden until authenticated) -->
  <div id="dashboard-view" class="hidden">
    <!-- Header -->
    <header class="mb-8 p-4 bg-white card rounded-xl flex justify-between items-center flex-wrap gap-4">
      <div>
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">داشبورد دانشجویی من</h1>
        <p class="text-gray-500 mb-4">مدیریت دروس، نمرات، برنامه‌ریزی هفتگی و محاسبه معدل.</p>
        <div id="user-info-display" class="text-sm text-gray-400 font-mono overflow-auto whitespace-nowrap">در حال بارگذاری اطلاعات کاربر...</div>
      </div>
      <button onclick="signOutUser()" class="bg-red-500 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium flex items-center">
        <i class="fas fa-sign-out-alt ml-2"></i>خروج
      </button>
    </header>

    <!-- Tabs -->
    <nav class="mb-8">
      <ul class="flex border-b border-gray-300">
        <li class="mr-1">
          <button onclick="changeTab('overview')" class="tab-button inline-block py-2 px-4 text-gray-500 hover:text-indigo-600 hover:border-indigo-600 border-b-2 border-transparent transition duration-150 tab-active" data-tab="overview">
            <i class="fas fa-chart-line ml-2"></i>خلاصه و معدل
          </button>
        </li>
        <li class="mr-1">
          <button onclick="changeTab('courses')" class="tab-button inline-block py-2 px-4 text-gray-500 hover:text-indigo-600 hover:border-indigo-600 border-b-2 border-transparent transition duration-150" data-tab="courses">
            <i class="fas fa-book-open ml-2"></i>مدیریت دروس و نمرات
          </button>
        </li>
        <li class="mr-1">
          <button onclick="changeTab('weekly')" class="tab-button inline-block py-2 px-4 text-gray-500 hover:text-indigo-600 hover:border-indigo-600 border-b-2 border-transparent transition duration-150" data-tab="weekly">
            <i class="fas fa-calendar-alt ml-2"></i>برنامه‌ریزی هفتگی
          </button>
        </li>
      </ul>
    </nav>

    <!-- Content Sections (Tabs) -->

    <!-- 1. Overview Tab -->
    <section id="overview" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- GPA and Term Summary Card -->
        <div class="lg:col-span-2 bg-white p-6 card rounded-xl">
          <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">خلاصه معدل</h2>
          <div class="flex flex-wrap items-center justify-between mb-6">
            <div class="text-center p-4 bg-indigo-50 rounded-lg w-full sm:w-auto mb-4 sm:mb-0">
              <p class="text-5xl font-extrabold text-indigo-600" id="total-gpa">--</p>
              <p class="text-gray-500">معدل کل</p>
            </div>
            <div class="flex flex-wrap gap-4 w-full sm:w-auto justify-around sm:justify-start">
              <div class="text-center p-3 bg-green-50 rounded-lg">
                <p class="text-2xl font-bold text-green-600" id="total-units">--</p>
                <p class="text-sm text-gray-500">کل واحدها</p>
              </div>
              <div class="text-center p-3 bg-red-50 rounded-lg">
                <p class="text-2xl font-bold text-red-600" id="passed-units">--</p>
                <p class="text-sm text-gray-500">واحدهای گذرانده</p>
              </div>
            </div>
          </div>

          <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-3">تاریخچه ترم‌ها</h3>
          <div class="overflow-x-auto custom-scroll">
            <table class="min-w-full bg-white rounded-lg border border-gray-200">
              <thead>
                <tr class="bg-gray-100 text-right text-gray-600 text-sm leading-normal">
                  <th class="py-3 px-6">ترم</th>
                  <th class="py-3 px-6">تعداد واحد</th>
                  <th class="py-3 px-6">معدل ترم</th>
                </tr>
              </thead>
              <tbody class="text-gray-600 text-sm font-light" id="terms-gpa-list">
                <!-- Term GPA data will be rendered here -->
                <tr><td colspan="3" class="text-center py-4">داده‌ای یافت نشد.</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Term Management Card -->
        <div class="bg-white p-6 card rounded-xl">
          <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">مدیریت ترم‌ها</h2>
          <form id="term-form" class="space-y-4">
            <div>
              <label for="new-term-name" class="block text-sm font-medium text-gray-700">نام ترم (مثال: نیمسال اول ۱۴۰۲)</label>
              <input type="text" id="new-term-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
            </div>
            <button type="submit" class="btn-primary text-white py-2 px-4 rounded-lg w-full">
              <i class="fas fa-calendar-plus ml-2"></i>اضافه کردن ترم
            </button>
          </form>

          <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-3 border-t pt-4">لیست ترم‌ها</h3>
          <ul id="term-list" class="space-y-2 max-h-60 overflow-y-auto custom-scroll">
            <!-- Term list items will be rendered here -->
            <li class="text-gray-500 text-sm">ترم فعالی تعریف نشده است.</li>
          </ul>
        </div>

      </div>
    </section>

    <!-- 2. Courses and Grades Tab -->
    <section id="courses" class="tab-content hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Course Form Card -->
        <div class="bg-white p-6 card rounded-xl lg:col-span-1">
          <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2" id="course-form-title">افزودن درس جدید</h2>
          <form id="course-form" class="space-y-4">
            <input type="hidden" id="course-id">
            <div>
              <label for="course-name" class="block text-sm font-medium text-gray-700">نام درس</label>
              <input type="text" id="course-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
            </div>
            <div>
              <label for="course-professor" class="block text-sm font-medium text-gray-700">نام استاد</label>
              <input type="text" id="course-professor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="نام استاد درس (اختیاری)">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="course-units" class="block text-sm font-medium text-gray-700">تعداد واحد</label>
                <input type="number" id="course-units" min="0.5" step="0.5" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
              </div>
              <div>
                <label for="course-term" class="block text-sm font-medium text-gray-700">ترم</label>
                <select id="course-term" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                  <option value="">ترم را انتخاب کنيد</option>
                </select>
              </div>
            </div>
            <div>
              <label for="course-grade" class="block text-sm font-medium text-gray-700">نمره کسب شده (اختیاری)</label>
              <input type="number" id="course-grade" min="0" max="20" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="برای محاسبه معدل، نمره را وارد کنید.">
            </div>
            <div>
              <label for="course-description" class="block text-sm font-medium text-gray-700">توضیحات (اختیاری)</label>
              <textarea id="course-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="یادداشت‌های شخصی، منابع مهم یا نکات کلیدی"></textarea>
            </div>
            <button type="submit" id="add-course-btn" class="btn-primary text-white py-2 px-4 rounded-lg w-full">
              <i class="fas fa-plus ml-2"></i>اضافه کردن درس
            </button>
            <button type="button" id="cancel-edit-btn" onclick="resetCourseForm()" class="btn-secondary text-white py-2 px-4 rounded-lg w-full hidden">
              <i class="fas fa-times ml-2"></i>انصراف از ویرایش
            </button>
          </form>
        </div>

        <!-- Courses List Card -->
        <div class="bg-white p-6 card rounded-xl lg:col-span-2">
          <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">لیست دروس</h2>

          <!-- Filter -->
          <div class="mb-4 flex space-x-4 space-x-reverse items-center">
            <label for="term-filter" class="text-sm font-medium text-gray-700 whitespace-nowrap">فیلتر ترم:</label>
            <select id="term-filter" onchange="renderCoursesList()" class="rounded-md border-gray-300 shadow-sm p-2 border w-full sm:w-auto">
              <option value="all">همه ترم‌ها</option>
            </select>
          </div>

          <!-- Course Table -->
          <div class="overflow-x-auto custom-scroll">
            <table class="min-w-full bg-white rounded-lg border border-gray-200">
              <thead>
                <tr class="bg-gray-100 text-right text-gray-600 text-sm leading-normal">
                  <th class="py-3 px-6">نام درس</th>
                  <th class="py-3 px-6">استاد</th>
                  <th class="py-3 px-6">واحد</th>
                  <th class="py-3 px-6">ترم</th>
                  <th class="py-3 px-6">نمره</th>
                  <th class="py-3 px-6">وضعیت</th>
                  <th class="py-3 px-6">عملیات</th>
                </tr>
              </thead>
              <tbody class="text-gray-600 text-sm font-light" id="courses-list">
                <!-- Course data will be rendered here -->
                <tr><td colspan="7" class="text-center py-4">درسی یافت نشد.</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Course Details Modal (for Description) -->
          <div id="details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4">
              <h3 id="modal-course-name" class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2"></h3>
              <div class="space-y-3">
                <p class="text-sm"><span class="font-medium text-gray-600">استاد:</span> <span id="modal-course-professor"></span></p>
                <p class="text-sm"><span class="font-medium text-gray-600">ترم:</span> <span id="modal-course-term"></span></p>
                <p class="text-sm font-medium text-gray-700 border-t pt-3 mt-3">توضیحات:</p>
                <p id="modal-course-description" class="p-3 bg-gray-50 rounded-lg whitespace-pre-wrap text-gray-600"></p>
              </div>
              <button onclick="closeModal()" class="mt-6 btn-primary text-white py-2 px-4 rounded-lg w-full">بستن</button>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- 3. Weekly Schedule Tab -->
    <section id="weekly" class="tab-content hidden">
      <div class="bg-white p-6 card rounded-xl">
          <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">برنامه‌ریزی هفتگی</h2>

          <!-- Filter -->
          <div class="mb-6 flex space-x-4 space-x-reverse items-center">
            <label for="weekly-term-filter" class="text-sm font-medium text-gray-700 whitespace-nowrap">فیلتر ترم:</label>
            <select id="weekly-term-filter" onchange="renderWeeklySchedule()" class="rounded-md border-gray-300 shadow-sm p-2 border w-full sm:w-auto">
              <option value="all">همه ترم‌ها</option>
            </select>
          </div>

          <!-- Schedule Setup Form -->
          <h3 class="text-xl font-semibold text-gray-700 mb-3">اضافه کردن زمان‌بندی هفتگی برای درس</h3>
          <form id="schedule-form" class="space-y-4 mb-6 p-4 border rounded-lg bg-gray-50">
            <div>
              <label for="schedule-course" class="block text-sm font-medium text-gray-700">درس</label>
              <select id="schedule-course" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                <option value="">درس را انتخاب کنيد</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="schedule-day" class="block text-sm font-medium text-gray-700">روز</label>
                <select id="schedule-day" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                  <option value="">روز را انتخاب کنيد</option>
                  <option value="شنبه">شنبه</option>
                  <option value="یکشنبه">یکشنبه</option>
                  <option value="دوشنبه">دوشنبه</option>
                  <option value="سه‌شنبه">سه‌شنبه</option>
                  <option value="چهارشنبه">چهارشنبه</option>
                  <option value="پنجشنبه">پنجشنبه</option>
                  <option value="جمعه">جمعه</option>
                </select>
              </div>
              <div>
                <label for="schedule-start-time" class="block text-sm font-medium text-gray-700">ساعت شروع</label>
                <input type="time" id="schedule-start-time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
              </div>
              <!-- Keep end time hidden for data completeness, even if not displayed on UI -->
              <input type="hidden" id="schedule-end-time" value="00:00">
            </div>
            <button type="submit" class="btn-primary text-white py-2 px-4 rounded-lg w-full">
              <i class="fas fa-clock ml-2"></i>ثبت برنامه
            </button>
          </form>


          <!-- Weekly Schedule Table -->
          <div class="overflow-x-auto custom-scroll">
            <table class="min-w-full bg-white rounded-lg border border-gray-200">
              <thead>
                <tr class="bg-gray-100 text-right text-gray-600 text-sm leading-normal">
                  <th class="py-3 px-6 w-1/7">شنبه</th>
                  <th class="py-3 px-6 w-1/7">یکشنبه</th>
                  <th class="py-3 px-6 w-1/7">دوشنبه</th>
                  <th class="py-3 px-6 w-1/7">سه‌شنبه</th>
                  <th class="py-3 px-6 w-1/7">چهارشنبه</th>
                  <th class="py-3 px-6 w-1/7">پنجشنبه</th>
                  <th class="py-3 px-6 w-1/7">جمعه</th>
                </tr>
              </thead>
              <tbody class="text-gray-600 text-sm font-light" id="weekly-schedule-body">
                <!-- Schedule data will be rendered here (one row representing all days) -->
              </tbody>
            </table>
          </div>

      </div>
    </section>

  </div> <!-- End of Dashboard View -->


<!-- Firebase and Application Logic -->
<script type="module">
  // --- Firebase Setup ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    sendPasswordResetEmail,
    signOut 
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    collection, 
    onSnapshot, 
    setDoc, 
    updateDoc, 
    deleteDoc, 
    setLogLevel 
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- HARDCODED FIREBASE CONFIGURATION ---
  // Using the configuration provided by the user for direct initialization.
  const firebaseConfig = {
    apiKey: "AIzaSyB5qX596rhI5tszzF_k2B3fX95lIvR_eDE",
    authDomain: "student-4f362.firebaseapp.com",
    projectId: "student-4f362",
    storageBucket: "student-4f362.firebasestorage.app",
    messagingSenderId: "256541012363",
    appId: "1:256541012363:web:d7e629ec248d11bce13f8e",
    measurementId: "G-JZ69LTL6EF"
  };
  // The appId value is used as the unique application identifier for Firestore paths.
  const appId = firebaseConfig.appId;
  // ----------------------------------------

  let app, db, auth;
  let userId = null;
  let userEmail = null; // Store user email
  let courses = [];
  let terms = [];

  // Utility function to show custom messages (replaces alert())
  function displayMessage(message, type = 'info') {
    const box = document.getElementById('message-box');
    box.textContent = message;
    box.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 p-4 rounded-lg shadow-xl text-white font-medium transition-all duration-300';
    
    if (type === 'success') {
      box.classList.add('bg-green-500');
    } else if (type === 'error') {
      box.classList.add('bg-red-500');
    } else {
      box.classList.add('bg-indigo-500');
    }
    
    box.classList.remove('hidden');
    
    setTimeout(() => {
      box.classList.add('hidden');
    }, 4000);
  }

  /**
   * Toggles the visibility of the password field.
   * @param {string} inputId - The ID of the password input field.
   */
  window.togglePasswordVisibility = function(inputId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(`${inputId}-toggle`);

      if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
      } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
      }
  }

  /**
   * Generates the secure, user-scoped Firestore path for a collection.
   * @param {string} collectionName - The name of the sub-collection (e.g., 'courses').
   */
  function getUserCollectionRef(collectionName) {
    if (!userId) {
      console.error("User ID is not set. Cannot access Firestore.");
      return null;
    }
    // Private data path: /artifacts/{appId}/users/{userId}/{collectionName}
    // Note: We use the hardcoded appId from the config here.
    return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
  }


  // --- View Management ---

  /**
   * Switches between Auth View and Dashboard View.
   * @param {string} view - 'auth' or 'dashboard'.
   */
  function switchView(view) {
      document.getElementById('auth-view').classList.toggle('hidden', view === 'dashboard');
      document.getElementById('dashboard-view').classList.toggle('hidden', view === 'auth');
  }

  /**
   * Switches between login, register, and forgot password forms.
   * @param {string} form - 'login', 'register', or 'forgot-password'.
   */
  window.showAuthForm = function(form) {
      document.getElementById('login-form-container').classList.add('hidden');
      document.getElementById('register-form-container').classList.add('hidden');
      document.getElementById('forgot-password-container').classList.add('hidden');

      if (form === 'login') {
          document.getElementById('login-form-container').classList.remove('hidden');
      } else if (form === 'register') {
          document.getElementById('register-form-container').classList.remove('hidden');
      } else if (form === 'forgot-password') {
          document.getElementById('forgot-password-container').classList.remove('hidden');
      }
  }

  // --- Firebase Authentication ---

  /**
   * Initializes Firebase and sets up the Auth State Listener.
   */
  function setupFirebase() {
    try {
      // Initialize using the hardcoded config
      app = initializeApp(firebaseConfig); 
      db = getFirestore(app);
      auth = getAuth(app);
      setLogLevel('debug');
      
      document.getElementById('loading-text').textContent = 'بررسی وضعیت ورود...';
      
      // Auth state listener handles persistence and initial user check
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // User is signed in
          userId = user.uid;
          userEmail = user.email;
          console.log("User authenticated:", userId);
          document.getElementById('user-info-display').innerHTML = `
              <span class="text-indigo-600 font-semibold">${userEmail}</span>
              <span class="text-gray-400"> | UID: ${userId.substring(0, 8)}...</span>
          `;
          switchView('dashboard');
          loadAllDataListeners(); 
        } else {
          // User is signed out or not authenticated
          userId = null;
          userEmail = null;
          console.log("User is signed out.");
          switchView('auth');
          // Clear data arrays when logged out
          courses = [];
          terms = [];
        }
        document.getElementById('loading-overlay').classList.add('hidden');
      });

    } catch (error) {
      console.error("Firebase setup error:", error);
      displayMessage(`خطای راه‌اندازی فایربیس: ${error.message}`, 'error');
      document.getElementById('loading-overlay').classList.add('hidden');
    }
  }
  
  /**
   * Handles user sign in.
   */
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    document.getElementById('loading-overlay').classList.remove('hidden');
    document.getElementById('loading-text').textContent = 'در حال ورود...';

    try {
      await signInWithEmailAndPassword(auth, email, password);
      // Auth state listener handles success (switchView and load data)
      displayMessage('با موفقیت وارد شدید!', 'success');
    } catch (error) {
      console.error("Login error:", error);
      let errorMessage = 'خطای ورود. لطفا ایمیل یا رمز عبور را بررسی کنید.';
      if (error.code === 'auth/user-not-found') {
        errorMessage = 'کاربری با این ایمیل یافت نشد.';
      } else if (error.code === 'auth/wrong-password') {
        errorMessage = 'رمز عبور اشتباه است.';
      } else if (error.code === 'auth/operation-not-allowed') {
        // CRITICAL: This is the error the user is facing, providing explicit instruction.
        errorMessage = 'خطای پیکربندی فایربیس (auth/operation-not-allowed). لطفا در کنسول فایربیس، روش ورود با "ایمیل/رمز عبور" را فعال کنید.';
      }
      displayMessage(errorMessage, 'error');
      document.getElementById('loading-overlay').classList.add('hidden');
    }
  });

  /**
   * Handles user registration.
   */
  document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    
    document.getElementById('loading-overlay').classList.remove('hidden');
    document.getElementById('loading-text').textContent = 'در حال ثبت نام...';

    try {
      await createUserWithEmailAndPassword(auth, email, password);
      // Auth state listener handles success (switchView and load data)
      displayMessage('ثبت نام با موفقیت انجام شد! وارد شدید.', 'success');
      showAuthForm('login'); // Switch to login form after registration
    } catch (error) {
      console.error("Registration error:", error);
      let errorMessage = 'خطا در ثبت نام. لطفا مجددا تلاش کنید.';
      if (error.code === 'auth/email-already-in-use') {
        errorMessage = 'این ایمیل قبلاً ثبت نام شده است.';
      } else if (error.code === 'auth/weak-password') {
        errorMessage = 'رمز عبور باید حداقل ۶ کاراکتر باشد.';
      } else if (error.code === 'auth/operation-not-allowed') {
        // CRITICAL: This is the error the user is facing, providing explicit instruction.
        errorMessage = 'خطای پیکربندی فایربیس (auth/operation-not-allowed). لطفا در کنسول فایربیس، روش ورود با "ایمیل/رمز عبور" را فعال کنید.';
      }
      displayMessage(errorMessage, 'error');
      document.getElementById('loading-overlay').classList.add('hidden');
    }
  });
  
  /**
   * Handles password reset email request.
   */
  document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('forgot-email').value;
    
    document.getElementById('loading-overlay').classList.remove('hidden');
    document.getElementById('loading-text').textContent = 'در حال ارسال ایمیل...';

    try {
      await sendPasswordResetEmail(auth, email);
      displayMessage(`لینک بازیابی رمز عبور به ایمیل ${email} ارسال شد. صندوق ورودی خود را بررسی کنید.`, 'success');
      showAuthForm('login'); // Redirect to login after successful request
    } catch (error) {
      console.error("Password reset error:", error);
      let errorMessage = 'خطا در ارسال ایمیل. لطفا ایمیل را بررسی کنید یا مجدداً تلاش نمایید.';
      if (error.code === 'auth/user-not-found') {
        errorMessage = 'کاربری با این ایمیل یافت نشد.';
      }
      displayMessage(errorMessage, 'error');
    } finally {
        document.getElementById('loading-overlay').classList.add('hidden');
    }
  });
  
  /**
   * Handles user sign out.
   */
  window.signOutUser = async function() {
      try {
          await signOut(auth);
          displayMessage('با موفقیت خارج شدید.', 'info');
      } catch (error) {
          console.error("Sign out error:", error);
          displayMessage('خطا در خروج از حساب کاربری.', 'error');
      }
  }

  // --- Real-Time Data Listeners (Only active when logged in) ---

  /**
   * Sets up real-time listeners for all user data collections.
   */
  function loadAllDataListeners() {
    if (!userId) return;

    // 1. Courses Listener
    onSnapshot(getUserCollectionRef('courses'), (snapshot) => {
      courses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      console.log("Courses updated:", courses.length);
      renderCoursesList();
      calculateGPA();
      renderWeeklySchedule();
      loadCourseOptions(); 
    }, (error) => {
      console.error("Error listening to courses:", error);
      displayMessage("خطا در دريافت ليست دروس.", 'error');
    });

    // 2. Terms Listener
    onSnapshot(getUserCollectionRef('terms'), (snapshot) => {
      terms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
      console.log("Terms updated:", terms.length);
      renderTermsList();
      loadTermOptions(); 
      calculateGPA(); 
    }, (error) => {
      console.error("Error listening to terms:", error);
      displayMessage("خطا در دريافت ليست ترم‌ها.", 'error');
    });
  }

  // --- Data Display and Calculation Functions (Same as before, adapted for new context) ---

  /**
   * Renders the list of terms in the Term Management card.
   */
  function renderTermsList() {
    const termListElement = document.getElementById('term-list');
    termListElement.innerHTML = '';

    if (terms.length === 0) {
      termListElement.innerHTML = '<li class="text-gray-500 text-sm">ترم فعالی تعریف نشده است.</li>';
      return;
    }

    terms.forEach(term => {
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md';
      li.innerHTML = `
        <span class="font-medium">${term.name}</span>
        <button onclick="deleteTerm('${term.id}')" class="text-red-500 hover:text-red-700 transition duration-150 p-1 rounded-full hover:bg-red-100" title="حذف ترم">
          <i class="fas fa-trash-alt text-sm"></i>
        </button>
      `;
      termListElement.appendChild(li);
    });
  }

  /**
   * Updates term filter and course term dropdowns based on loaded terms.
   */
  window.loadTermOptions = function() {
    const termFilter = document.getElementById('term-filter');
    const weeklyTermFilter = document.getElementById('weekly-term-filter');
    const courseTerm = document.getElementById('course-term');

    [termFilter, weeklyTermFilter].forEach(select => {
      const selectedValue = select.value;
      select.innerHTML = '<option value="all">همه ترم‌ها</option>';
      terms.forEach(term => {
        const option = document.createElement('option');
        option.value = term.name;
        option.textContent = term.name;
        select.appendChild(option);
      });
      select.value = selectedValue; // Restore selected value after refresh
    });

    const selectedCourseTerm = courseTerm.value;
    courseTerm.innerHTML = '<option value="">ترم را انتخاب کنيد</option>';
    terms.forEach(term => {
      const option = document.createElement('option');
      option.value = term.name;
      option.textContent = term.name;
      courseTerm.appendChild(option);
    });
    courseTerm.value = selectedCourseTerm;
  };

  /**
   * Renders the list of courses based on the current term filter.
   */
  window.renderCoursesList = function() {
    const listElement = document.getElementById('courses-list');
    const filter = document.getElementById('term-filter').value;

    const filteredCourses = courses.filter(course => 
      filter === 'all' || course.term === filter
    );

    listElement.innerHTML = '';

    if (filteredCourses.length === 0) {
      listElement.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">درسی در این ترم یافت نشد.</td></tr>';
      return;
    }

    filteredCourses.forEach(course => {
      const grade = course.grade || '---';
      const isPassed = course.grade >= 10;
      const statusText = course.grade ? (isPassed ? 'قبول' : 'رد') : 'ناقص';
      const statusClass = course.grade ? (isPassed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') : 'bg-yellow-100 text-yellow-800';
      const professor = course.professor || '---';

      const row = document.createElement('tr');
      row.className = 'border-b border-gray-200 hover:bg-gray-50';
      
      row.innerHTML = `
        <td class="py-3 px-6 text-right whitespace-nowrap">${course.name}</td>
        <td class="py-3 px-6 text-right whitespace-nowrap">${professor}</td>
        <td class="py-3 px-6 text-right">${course.units}</td>
        <td class="py-3 px-6 text-right">${course.term}</td>
        <td class="py-3 px-6 text-right font-bold">${grade}</td>
        <td class="py-3 px-6 text-right">
          <span class="relative inline-block px-3 py-1 font-semibold leading-tight">
            <span aria-hidden class="absolute inset-0 opacity-50 rounded-full ${statusClass}"></span>
            <span class="relative text-xs">${statusText}</span>
          </span>
        </td>
        <td class="py-3 px-6 text-right">
          <div class="flex item-center justify-start space-x-2 space-x-reverse">
            <!-- New Button for Details/Description -->
            <button onclick="showDetailsModal('${course.id}')" class="w-4 mr-2 transform hover:text-blue-500 hover:scale-110" title="مشاهده جزئیات/توضیحات">
              <i class="fas fa-info-circle"></i>
            </button>
            <button onclick="startEditCourse('${course.id}')" class="w-4 mr-2 transform hover:text-indigo-500 hover:scale-110" title="ویرایش">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteCourse('${course.id}')" class="w-4 mr-2 transform hover:text-red-500 hover:scale-110" title="حذف">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </td>
      `;
      listElement.appendChild(row);
    });
  };

  /**
   * Opens the modal to display full course details including description.
   * @param {string} id - The Firestore document ID of the course.
   */
  window.showDetailsModal = function(id) {
    const course = courses.find(c => c.id === id);
    if (!course) return;

    document.getElementById('modal-course-name').textContent = course.name;
    document.getElementById('modal-course-professor').textContent = course.professor || '---';
    document.getElementById('modal-course-term').textContent = course.term;
    document.getElementById('modal-course-description').textContent = course.description || 'توضیحاتی برای این درس ثبت نشده است.';
    document.getElementById('details-modal').classList.remove('hidden');
  };

  /**
   * Closes the course details modal.
   */
  window.closeModal = function() {
    document.getElementById('details-modal').classList.add('hidden');
  };


  /**
   * Calculates and displays the overall GPA and term GPAs.
   */
  window.calculateGPA = function() {
    let totalWeightedPoints = 0;
    let totalUnitsAttempted = 0;
    let totalUnitsPassed = 0;
    const termGPAs = {};

    courses.forEach(course => {
      const units = parseFloat(course.units);
      const grade = parseFloat(course.grade);

      if (units > 0) {
        totalUnitsAttempted += units;
        
        if (!isNaN(grade)) {
          totalWeightedPoints += grade * units;

          if (grade >= 10) {
            totalUnitsPassed += units;
          }

          // Term GPA calculation
          if (!termGPAs[course.term]) {
            termGPAs[course.term] = { weightedPoints: 0, units: 0 };
          }
          termGPAs[course.term].weightedPoints += grade * units;
          termGPAs[course.term].units += units;
        }
      }
    });

    // Overall GPA
    const totalGPA = totalUnitsAttempted > 0 ? (totalWeightedPoints / totalUnitsAttempted).toFixed(2) : '--';
    document.getElementById('total-gpa').textContent = totalGPA;
    document.getElementById('total-units').textContent = totalUnitsAttempted.toFixed(1);
    document.getElementById('passed-units').textContent = totalUnitsPassed.toFixed(1);

    // Term GPA List
    const termListBody = document.getElementById('terms-gpa-list');
    termListBody.innerHTML = '';
    
    // Get term names in order they were added (or use existing terms array)
    const sortedTermNames = terms.map(t => t.name);

    if (sortedTermNames.length === 0) {
        termListBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">هیچ داده‌ای برای محاسبه معدل ترم‌ها وجود ندارد.</td></tr>';
        return;
    }

    sortedTermNames.forEach(termName => {
      const termData = termGPAs[termName];
      if (termData && termData.units > 0) {
        const gpa = (termData.weightedPoints / termData.units).toFixed(2);
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-gray-50';
        row.innerHTML = `
          <td class="py-3 px-6">${termName}</td>
          <td class="py-3 px-6">${termData.units.toFixed(1)}</td>
          <td class="py-3 px-6 font-bold">${gpa}</td>
        `;
        termListBody.appendChild(row);
      }
    });
    
    if (termListBody.children.length === 0) {
      termListBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">نمره‌ای برای محاسبه معدل ترم‌ها ثبت نشده است.</td></tr>';
    }
  };

  /**
   * Updates the course selection dropdown for the weekly schedule form.
   */
  window.loadCourseOptions = function() {
    const select = document.getElementById('schedule-course');
    select.innerHTML = '<option value="">درس را انتخاب کنيد</option>';
    
    // Only show courses that are part of a defined term
    const coursesWithTerm = courses.filter(c => c.term);

    coursesWithTerm.forEach(course => {
      const option = document.createElement('option');
      // The value stores the course ID for later retrieval
      option.value = course.id; 
      option.textContent = `${course.name} (${course.term})`;
      select.appendChild(option);
    });
  };

  /**
   * Renders the weekly schedule table without time slots on the left.
   * It shows all scheduled courses under the respective day, sorted by start time.
   */
  window.renderWeeklySchedule = function() {
    const scheduleBody = document.getElementById('weekly-schedule-body');
    const termFilter = document.getElementById('weekly-term-filter').value;
    scheduleBody.innerHTML = '';

    const days = ['شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه'];
    const scheduleByDay = days.reduce((acc, day) => ({ ...acc, [day]: [] }), {});

    // 1. Filter courses and populate scheduleByDay structure
    const filteredCourses = courses.filter(course => {
        // Filter by term
        const isTermMatch = termFilter === 'all' || course.term === termFilter;
        // Ensure schedule property exists and is an array
        return isTermMatch && Array.isArray(course.schedule) && course.schedule.length > 0;
    });

    filteredCourses.forEach(course => {
        course.schedule.forEach(item => {
            const day = item.day;
            if (days.includes(day)) {
                scheduleByDay[day].push({
                    name: course.name,
                    term: course.term,
                    courseId: course.id,
                    scheduleId: item.id, // Unique ID for this schedule entry for deletion
                    startTime: item.startTime,
                    endTime: item.endTime,
                });
            }
        });
    });

    // 2. Sort courses within each day by startTime
    days.forEach(day => {
        scheduleByDay[day].sort((a, b) => a.startTime.localeCompare(b.startTime));
    });

    // 3. Render the single row containing all daily data
    const row = document.createElement('tr');
    row.className = 'border-b border-gray-100';

    const hasSchedule = days.some(day => scheduleByDay[day].length > 0);

    if (!hasSchedule) {
        scheduleBody.innerHTML = `<tr><td colspan="7" class="text-center py-6 text-gray-500">برنامه‌ای برای نمایش وجود ندارد.</td></tr>`;
        return;
    }
    
    days.forEach(day => {
        const cell = document.createElement('td');
        cell.className = 'py-4 px-3 align-top border-l border-gray-200 last:border-l-0'; // Align top for better list view
        
        const entries = scheduleByDay[day];
        
        if (entries.length > 0) {
            cell.innerHTML = entries.map(entry => `
                <div class="p-2 my-1 rounded-lg text-xs font-medium bg-indigo-100 text-indigo-800 border border-indigo-200 shadow-sm relative group">
                    <div class="font-bold text-sm mb-0.5">${entry.startTime}</div>
                    ${entry.name}
                    <span class="block text-gray-600 font-normal text-[0.65rem]">(${entry.term})</span>
                    <!-- Delete Button -->
                    <button onclick="deleteScheduleItem('${entry.courseId}', '${entry.scheduleId}')" 
                            class="absolute top-0.5 left-0.5 text-red-500 hover:text-red-700 transition duration-150 opacity-0 group-hover:opacity-100 p-0.5 rounded-full bg-indigo-50"
                            title="حذف این زمان‌بندی">
                        <i class="fas fa-trash-alt text-[0.65rem]"></i>
                    </button>
                </div>
            `).join('');
        } else {
            cell.textContent = '-';
            cell.classList.add('text-center', 'text-gray-400');
        }
        row.appendChild(cell);
    });

    scheduleBody.appendChild(row);
  };


  // --- CRUD Operations (Firestore) ---

  /**
   * Handles adding/editing a course.
   */
  document.getElementById('course-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!userId) {
      displayMessage('لطفا ابتدا وارد شوید.', 'error');
      return;
    }

    const id = document.getElementById('course-id').value;
    const name = document.getElementById('course-name').value;
    const professor = document.getElementById('course-professor').value || null; // New field
    const units = parseFloat(document.getElementById('course-units').value);
    const term = document.getElementById('course-term').value;
    const gradeInput = document.getElementById('course-grade').value;
    const grade = gradeInput ? parseFloat(gradeInput) : null;
    const description = document.getElementById('course-description').value || null; // New field

    if (term === "") {
        displayMessage('لطفاً ترم را انتخاب کنید.', 'error');
        return;
    }

    const courseData = {
      name,
      professor, 
      units,
      term,
      grade,
      description, 
      timestamp: Date.now() 
    };

    try {
      if (id) {
        // Edit existing course
        await updateDoc(doc(getUserCollectionRef('courses'), id), courseData);
        displayMessage('درس با موفقیت ویرایش شد.', 'success');
      } else {
        // Add new course
        await setDoc(doc(getUserCollectionRef('courses')), { ...courseData, schedule: [] }); // Initialize schedule array
        displayMessage('درس با موفقیت اضافه شد.', 'success');
      }
      resetCourseForm();
    } catch (error) {
      console.error("Error saving course:", error);
      displayMessage(`خطا در ذخیره درس: ${error.message}`, 'error');
    }
  });
  
  /**
   * Starts the editing process for a course, populating the form.
   * @param {string} id - The Firestore document ID of the course.
   */
  window.startEditCourse = function(id) {
    const course = courses.find(c => c.id === id);
    if (!course) return;

    document.getElementById('course-id').value = course.id;
    document.getElementById('course-name').value = course.name;
    document.getElementById('course-professor').value = course.professor || ''; // Populate professor
    document.getElementById('course-units').value = course.units;
    document.getElementById('course-term').value = course.term;
    document.getElementById('course-grade').value = course.grade || '';
    document.getElementById('course-description').value = course.description || ''; // Populate description

    document.getElementById('course-form-title').textContent = 'ویرایش درس';
    document.getElementById('add-course-btn').innerHTML = '<i class="fas fa-save"></i> ذخیره تغییرات';
    document.getElementById('cancel-edit-btn').classList.remove('hidden');
    
    // Scroll to the form for better UX
    document.getElementById('course-form').scrollIntoView({ behavior: 'smooth' });
  };

  /**
   * Resets the course form to the 'Add New' state.
   */
  window.resetCourseForm = function() {
    document.getElementById('course-form').reset();
    document.getElementById('course-id').value = '';
    document.getElementById('course-form-title').textContent = 'افزودن درس جدید';
    document.getElementById('add-course-btn').innerHTML = '<i class="fas fa-plus"></i> اضافه کردن درس';
    document.getElementById('cancel-edit-btn').classList.add('hidden');
  };

  /**
   * Deletes a course from Firestore.
   * @param {string} id - The Firestore document ID of the course.
   */
  window.deleteCourse = async function(id) {
    if (!userId) return;
    // Using custom modal/confirmation is preferred over window.confirm in production
    if (window.confirm("آیا مطمئن هستید که می‌خواهید این درس را حذف کنید؟")) {
      try {
        await deleteDoc(doc(getUserCollectionRef('courses'), id));
        displayMessage('درس با موفقیت حذف شد.', 'success');
        resetCourseForm();
      } catch (error) {
        console.error("Error deleting course:", error);
        displayMessage(`خطا در حذف درس: ${error.message}`, 'error');
      }
    }
  };

  /**
   * Handles adding a new term.
   */
  document.getElementById('term-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!userId) return;

    const name = document.getElementById('new-term-name').value.trim();
    if (name === '') return;

    if (terms.some(t => t.name === name)) {
        displayMessage('این ترم قبلاً اضافه شده است.', 'error');
        return;
    }

    try {
      // Add new term to the 'terms' collection
      await setDoc(doc(getUserCollectionRef('terms')), {
        name: name,
        timestamp: Date.now()
      });
      document.getElementById('term-form').reset();
      displayMessage('ترم جدید با موفقیت اضافه شد.', 'success');
    } catch (error) {
      console.error("Error adding term:", error);
      displayMessage(`خطا در اضافه کردن ترم: ${error.message}`, 'error');
    }
  });

  /**
   * Deletes a term from Firestore.
   * @param {string} id - The Firestore document ID of the term.
   */
  window.deleteTerm = async function(id) {
    if (!userId) return;
    const termToDelete = terms.find(t => t.id === id);
    if (!termToDelete) return;

    // Check if any courses are using this term before allowing deletion
    const coursesInTerm = courses.filter(c => c.term === termToDelete.name);
    if (coursesInTerm.length > 0) {
      displayMessage(`ابتدا باید ${coursesInTerm.length} درس از این ترم را حذف یا ویرایش کنید.`, 'error');
      return;
    }

    if (window.confirm(`آیا مطمئن هستید که می‌خواهید ترم "${termToDelete.name}" را حذف کنید؟`)) {
      try {
        await deleteDoc(doc(getUserCollectionRef('terms'), id));
        displayMessage('ترم با موفقیت حذف شد.', 'success');
      } catch (error) {
        console.error("Error deleting term:", error);
        displayMessage(`خطا در حذف ترم: ${error.message}`, 'error');
      }
    }
  };


  /**
   * Handles adding a weekly schedule entry to a course's `schedule` array.
   */
  document.getElementById('schedule-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!userId) return;

    const courseId = document.getElementById('schedule-course').value;
    const day = document.getElementById('schedule-day').value;
    const startTime = document.getElementById('schedule-start-time').value;
    const endTime = document.getElementById('schedule-end-time').value || '00:00'; 
    
    if (!courseId || !day || !startTime) {
        displayMessage('لطفاً تمام فیلدهای برنامه هفتگی را پر کنید.', 'error');
        return;
    }

    const course = courses.find(c => c.id === courseId);
    if (!course) {
        displayMessage('درس انتخاب شده یافت نشد.', 'error');
        return;
    }

    const newScheduleItem = {
      id: crypto.randomUUID(), // Local ID for unique identification within the array
      day,
      startTime,
      endTime
    };
    
    // Ensure schedule is an array
    const updatedSchedule = Array.isArray(course.schedule) ? [...course.schedule, newScheduleItem] : [newScheduleItem];

    try {
      // Update the course document in Firestore
      await updateDoc(doc(getUserCollectionRef('courses'), courseId), {
        schedule: updatedSchedule
      });
      document.getElementById('schedule-form').reset();
      displayMessage('برنامه هفتگی با موفقیت ثبت شد.', 'success');
    } catch (error) {
      console.error("Error adding schedule:", error);
      displayMessage(`خطا در ثبت برنامه هفتگی: ${error.message}`, 'error');
    }
  });

  /**
   * Deletes a specific schedule item from a course.
   * @param {string} courseId - The Firestore document ID of the course.
   * @param {string} scheduleId - The local unique ID of the schedule item.
   */
  window.deleteScheduleItem = async function(courseId, scheduleId) {
    if (!userId) return;

    if (!window.confirm("آیا مطمئن هستید که می‌خواهید این زمان‌بندی را حذف کنید؟")) {
        return;
    }

    try {
        const course = courses.find(c => c.id === courseId);
        if (!course || !Array.isArray(course.schedule)) return;

        // Filter out the item to be deleted
        const updatedSchedule = course.schedule.filter(item => item.id !== scheduleId);

        // Update Firestore
        await updateDoc(doc(getUserCollectionRef('courses'), courseId), {
            schedule: updatedSchedule
        });
        displayMessage('زمان‌بندی حذف شد.', 'success');
    } catch (error) {
        console.error("Error deleting schedule item:", error);
        displayMessage(`خطا در حذف زمان‌بندی: ${error.message}`, 'error');
    }
  };


  // --- Tab Management ---

  window.changeTab = function(tabId) {
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.add('hidden');
    });
    document.getElementById(tabId).classList.remove('hidden');

    document.querySelectorAll('.tab-button').forEach(button => {
      button.classList.remove('tab-active');
    });
    document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('tab-active');

    // Trigger renders when switching to ensure freshness
    if (tabId === 'overview') {
      calculateGPA();
    } else if (tabId === 'courses') {
      renderCoursesList();
    } else if (tabId === 'weekly') {
      renderWeeklySchedule();
    }
  };

  // --- Initialize App ---
  window.onload = function() {
    setupFirebase();
  };
</script>
</body>
</html>
